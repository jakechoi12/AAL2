<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neo Helios - Quick Quote Request</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Styles - Design System -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/base.css">
    <link rel="stylesheet" href="../css/components/header.css">
    <link rel="stylesheet" href="../css/components/auth.css">
    
    <style>
        :root {
            --bg-color: #0b0b0d;
            --text-main: #ffffff;
            --text-sub: #9ca3af;
            --accent-color: #3b82f6;
            --card-bg: #141416;
            --border-color: rgba(255, 255, 255, 0.1);
            --input-bg: #1c1c1f;
            --font-main: 'Inter', 'Pretendard', sans-serif;
            --transition: all 0.2s ease;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: var(--font-main); font-size: 14px; }

        .container { max-width: 1600px; margin: 0 auto; padding: 2rem; padding-top: 120px; display: grid; grid-template-columns: 1fr 320px; gap: 2rem; }
        
        /* Main Form Area */
        h2 { font-size: 1.5rem; margin-bottom: 2rem; font-weight: 700; }
        
        .section { margin-bottom: 2.5rem; }
        .section-header { display: flex; align-items: center; gap: 8px; margin-bottom: 1rem; font-size: 1.1rem; font-weight: 600; }
        .info-icon { color: var(--text-sub); font-size: 0.9rem; cursor: pointer; }

        /* Grid Systems */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; }

        /* Custom Cards */
        .option-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px;
            padding: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; transition: var(--transition); color: var(--text-sub); min-height: 80px;
        }
        .option-card:hover { border-color: var(--accent-color); }
        .option-card.active { background: rgba(59, 130, 246, 0.1); border-color: var(--accent-color); color: var(--accent-color); font-weight: 600; }
        .option-card i { font-size: 1.2rem; }
        
        .icon-box {
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            background: #333; color: white; font-weight: bold; border-radius: 4px; font-size: 0.8rem;
        }
        .active .icon-box { background: var(--accent-color); }

        /* Inputs */
        .input-group { display: flex; flex-direction: column; gap: 6px; position: relative; }
        .input-group label { font-size: 0.85rem; color: var(--text-sub); }
        .form-input {
            background: var(--input-bg); border: 1px solid var(--border-color); color: white;
            padding: 10px; border-radius: 4px; font-family: inherit; width: 100%;
        }
        .form-input:focus { outline: none; border-color: var(--accent-color); }
        .form-input[readonly] { color: #777; cursor: not-allowed; }
        
        .icon-input-wrapper { position: relative; }
        .icon-input-wrapper i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }
        .icon-input-wrapper input { padding-left: 35px; }

        /* Date Input Group Styles */
        .date-input-group {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 6px 10px;
            padding-left: 35px;
        }
        .date-input-group:focus-within {
            border-color: var(--accent-color);
        }
        .date-input-group input {
            background: transparent;
            border: none;
            color: white;
            font-family: inherit;
            font-size: inherit;
            text-align: center;
            padding: 4px 0;
        }
        .date-input-group input:focus {
            outline: none;
            background: rgba(59, 130, 246, 0.15);
            border-radius: 3px;
        }
        .date-input-group input::placeholder {
            color: #555;
        }
        .date-input-group .date-year {
            width: 50px;
        }
        .date-input-group .date-month,
        .date-input-group .date-day {
            width: 32px;
        }
        .date-input-group .date-separator {
            color: var(--text-sub);
            font-weight: 400;
            user-select: none;
        }
        .date-input-group .date-hour,
        .date-input-group .date-minute {
            width: 32px;
        }
        .time-fields {
            display: none;
        }
        
        /* Date Validation Error */
        .date-input-group.error {
            border-color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.08);
        }
        .date-error-message {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .date-error-message i {
            font-size: 0.7rem;
        }

        /* Incoterms */
        .incoterm-card {
            border: 1px solid var(--border-color); border-radius: 6px; padding: 1.5rem;
            text-align: center; cursor: pointer; display: flex; flex-direction: column; gap: 10px;
            align-items: center; min-height: 140px; justify-content: center;
        }
        .incoterm-card.active { background: rgba(59, 130, 246, 0.1); border-color: var(--accent-color); }
        .incoterm-card .title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .incoterm-card.active .title { color: var(--accent-color); }
        .incoterm-card .desc { font-size: 0.8rem; color: var(--text-sub); line-height: 1.4; }
        .incoterm-card.active .desc { color: #93c5fd; }

        /* Cargo Details */
        .cargo-row { display: grid; grid-template-columns: 2fr 1.5fr 1.5fr 1fr 40px; gap: 10px; margin-bottom: 10px; align-items: flex-end; position: relative; }
        .cargo-row .row-delete { 
            color: #666; 
            cursor: pointer; 
            align-self: center; 
            margin-top: 20px; 
            transition: color 0.2s;
            font-size: 1.1rem;
        }
        .cargo-row .row-delete:hover { color: #ef4444; }
        .cargo-row .row-delete.disabled { color: #333; cursor: not-allowed; opacity: 0.3; }
        .cargo-row-number {
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
            color: #666;
            font-weight: 600;
        }
        .btn-add-row {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        .btn-add-row:hover { 
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }
        .btn-add-row:disabled {
            background: #374151;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.5;
        }
        .btn-add-row i { font-size: 0.7rem; }
        .row-counter {
            font-size: 0.75rem;
            color: #888;
            margin-left: 10px;
        }
        
        /* Checkbox & Radio */
        .checkbox-wrapper { display: flex; align-items: center; gap: 8px; margin: 15px 0; font-size: 0.9rem; }
        .radio-group { display: flex; gap: 15px; align-items: center; }
        .radio-label { display: flex; align-items: center; gap: 6px; cursor: pointer; color: var(--text-sub); }
        .radio-label input { accent-color: var(--accent-color); }
        .radio-label.checked { color: var(--text-main); }
        .text-red { color: #ef4444; font-weight: 600; }

        /* Additional Details */
        .detail-row { display: grid; grid-template-columns: 200px 1fr; gap: 20px; margin-bottom: 15px; align-items: center; }
        .detail-row label { color: var(--text-sub); }

        /* Sidebar */
        .summary-card { position: sticky; top: 20px; }
        .mode-toggle { text-align: right; margin-bottom: 20px; font-size: 0.9rem; color: var(--text-sub); }
        .mode-toggle span.active { color: var(--accent-color); font-weight: bold; }
        .summary-box { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; color: var(--text-main); }
        .summary-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .summary-list { list-style: none; font-size: 0.85rem; }
        .summary-list li { margin-bottom: 12px; display: flex; flex-direction: column; gap: 4px; }
        .s-label { color: var(--text-sub); font-size: 0.8rem; }
        .s-value { font-weight: 500; color: var(--accent-color); line-height: 1.4; min-height: 1.4em; }
        
        .action-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 50px; padding-top: 20px; border-top: 1px solid var(--border-color); grid-column: span 2; }
        .btn { padding: 10px 24px; border-radius: 4px; font-weight: 600; cursor: pointer; border: 1px solid transparent; }
        .btn-secondary { background: #eff6ff; color: var(--accent-color); }
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-primary:hover { background: #2563eb; }

        /* Remark Helper Styles */
        .remark-helper {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-color);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            color: var(--accent-color);
            line-height: 1.5;
        }
        #remark-section.highlighted .section-header {
            color: var(--accent-color);
        }
        #remark-section.highlighted textarea {
            border-color: var(--accent-color);
        }

        /* Validation Error Styles */
        .validation-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 20px;
            display: none;
        }
        .validation-error.show {
            display: block;
        }
        .validation-error-title {
            color: #ef4444;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .validation-error-list {
            color: #fca5a5;
            font-size: 0.85rem;
            line-height: 1.6;
            list-style: none;
            padding-left: 20px;
        }
        .validation-error-list li::before {
            content: "•";
            color: #ef4444;
            margin-right: 8px;
        }
        .form-input.error {
            border-color: #ef4444 !important;
            background: rgba(239, 68, 68, 0.05);
        }
        
        /* Weight Exceeded Warning - Fixed Position Tooltip */
        .input-group {
            position: relative;
        }
        .weight-warning {
            position: absolute;
            top: 0;
            right: 0;
            transform: translateY(-100%);
            background: rgba(231, 76, 60, 0.95);
            color: white;
            font-size: 0.7rem;
            padding: 6px 10px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            z-index: 100;
            white-space: nowrap;
            animation: tooltipFadeIn 0.2s ease;
        }
        .weight-warning::after {
            content: '';
            position: absolute;
            bottom: -6px;
            right: 12px;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(231, 76, 60, 0.95);
        }
        .weight-warning-line {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .weight-warning i {
            font-size: 0.75rem;
        }
        .fcl-weight.exceeded {
            border-color: #e74c3c !important;
            background: rgba(231, 76, 60, 0.08) !important;
        }
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-90%); }
            to { opacity: 1; transform: translateY(-100%); }
        }
        
        /* Quick Quotation Result Styles */
        .quick-quote-section {
            display: none;
            margin-bottom: 2.5rem;
        }
        .quick-quote-section.show {
            display: block;
        }
        .quick-quote-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.02) 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
        }
        .quick-quote-card.unavailable {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.02) 100%);
            border-color: rgba(239, 68, 68, 0.3);
        }
        .quick-quote-badge {
            position: absolute;
            top: -10px;
            left: 20px;
            background: var(--accent-color);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 20px;
            letter-spacing: 0.5px;
        }
        .quick-quote-badge.unavailable {
            background: #ef4444;
        }
        .quick-quote-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-top: 0.5rem;
        }
        .quick-quote-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-main);
        }
        .quick-quote-carrier {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-sub);
        }
        .quick-quote-carrier strong {
            color: var(--accent-color);
        }
        .quick-quote-breakdown {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .quick-quote-breakdown.vertical {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .quick-quote-group {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1rem;
        }
        .quick-quote-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        .quick-quote-step {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: var(--accent-color);
            color: white;
            border-radius: 50%;
            font-size: 0.85rem;
            font-weight: 700;
        }
        .quick-quote-group-title {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
        }
        .quick-quote-group-title i {
            margin-right: 6px;
            color: var(--accent-color);
        }
        .quick-quote-group-subtitle {
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--text-sub);
        }
        .quick-quote-items-list {
            margin-bottom: 0.5rem;
        }
        .quick-quote-item {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            padding: 8px 0;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .quick-quote-item:last-child {
            border-bottom: none;
        }
        .quick-quote-item-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .quick-quote-item-code {
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.85rem;
        }
        .quick-quote-item-name {
            font-size: 0.75rem;
            color: var(--text-sub);
        }
        .quick-quote-item-name-ko {
            font-size: 0.7rem;
            color: #888;
        }
        .quick-quote-item-rate {
            font-weight: 600;
            color: var(--text-main);
            text-align: right;
            font-size: 0.9rem;
        }
        .quick-quote-item-rate.na {
            color: #ef4444;
            font-style: italic;
        }
        .quick-quote-subtotal {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed var(--border-color);
            font-weight: 600;
        }
        .quick-quote-subtotal-label {
            color: var(--text-sub);
            font-size: 0.8rem;
        }
        .quick-quote-subtotal-value {
            color: var(--accent-color);
            font-size: 0.95rem;
        }
        .quick-quote-total-section {
            margin-top: 1.5rem;
            border-radius: 8px;
            overflow: hidden;
        }
        .quick-quote-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(59, 130, 246, 0.1);
        }
        .quick-quote-total-label {
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .quick-quote-total-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--accent-color);
        }
        .quick-quote-total-krw {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--accent-color);
        }
        .quick-quote-total-krw-label {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.8);
        }
        .quick-quote-total-krw-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }
        .quick-quote-meta {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            font-size: 0.8rem;
            color: rgba(255,255,255,0.9);
        }
        .quick-quote-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-breakdown-toggle {
            width: 100%;
            padding: 0.75rem;
            margin-top: 1rem;
            background: transparent;
            border: 1px dashed var(--border-color);
            border-radius: 6px;
            color: var(--text-sub);
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }
        .btn-breakdown-toggle:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }
        .btn-breakdown-toggle i {
            transition: transform 0.3s ease;
        }
        .btn-breakdown-toggle.expanded i {
            transform: rotate(180deg);
        }
        .quick-quote-total-breakdown {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .quick-quote-total-breakdown .quick-quote-total-label {
            color: var(--text-sub);
        }
        .quick-quote-total-breakdown .quick-quote-total-value {
            font-weight: 600;
            color: var(--accent-color);
        }
        .quick-quote-note {
            margin-top: 1rem;
            padding: 0.75rem;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 6px;
            font-size: 0.75rem;
            color: #ffc107;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .quick-quote-unavailable-msg {
            text-align: center;
            padding: 1.5rem;
        }
        .quick-quote-unavailable-msg h4 {
            color: #ef4444;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        .quick-quote-unavailable-msg p {
            color: var(--text-sub);
            font-size: 0.9rem;
        }
        .quick-quote-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 2rem;
            color: var(--text-sub);
        }
        .quick-quote-loading i {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Detailed Quote Request Button Styles */
        .btn-detailed-quote {
            width: 100%;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border: 2px dashed var(--accent-color);
            border-radius: 12px;
            color: var(--accent-color);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        .btn-detailed-quote:hover {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(59, 130, 246, 0.08) 100%);
            border-style: solid;
            transform: translateY(-2px);
        }
        .btn-detailed-quote .btn-hint {
            font-size: 0.8rem;
            font-weight: 400;
            color: var(--text-sub);
        }
        #detailed-quote-btn-section {
            margin-bottom: 2rem;
        }
        #detailed-quote-section {
            animation: fadeInUp 0.4s ease;
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Reefer Temperature Input - Matching DG Class Style */
        .reefer-temp-section {
            display: none;
            margin-top: 12px;
        }
        .reefer-temp-section.show {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .reefer-input-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .reefer-input-group label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .reefer-input-group label i {
            color: #00bcd4;
        }
        .temp-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .temp-input {
            flex: 1;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--input-bg);
            color: var(--text-color);
            font-size: 0.95rem;
            text-align: center;
        }
        .temp-input:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(233, 30, 99, 0.1);
        }
        .temp-separator {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        .temp-unit-toggle {
            display: flex;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        .temp-unit-btn {
            padding: 12px 14px;
            border: none;
            background: var(--input-bg);
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .temp-unit-btn.active {
            background: #00bcd4;
            color: white;
            font-weight: 500;
        }
        .temp-unit-btn:hover:not(.active) {
            background: rgba(0, 188, 212, 0.1);
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-overlay.show {
            display: flex;
        }
        .loading-content {
            text-align: center;
            color: white;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #333;
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast Message */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            display: none;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }
        .toast.show {
            display: block;
        }
        .toast.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .toast.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Success Modal Styles */
        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
            padding: 20px;
        }
        .success-modal.show {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* New RFQ Modal Styles */
        .rfq-modal-content {
            background: #ffffff;
            border-radius: 12px;
            padding: 30px 40px;
            max-width: 720px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: scaleIn 0.3s ease;
            color: #1f2937;
        }
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .rfq-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        .rfq-header-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .rfq-bidding-no {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }
        .rfq-deadline {
            font-size: 0.85rem;
            color: #6b7280;
        }
        .rfq-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        .rfq-close-btn:hover {
            color: #1f2937;
        }
        
        .rfq-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 25px;
            text-align: left;
        }
        
        .rfq-section {
            margin-bottom: 20px;
        }
        .rfq-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .rfq-grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        .rfq-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .rfq-field-label {
            font-size: 0.75rem;
            color: #9ca3af;
            text-transform: uppercase;
        }
        .rfq-field-value {
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2937;
        }
        
        .rfq-details-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .rfq-detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .rfq-detail-label {
            font-size: 0.75rem;
            color: #9ca3af;
        }
        .rfq-detail-value {
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2937;
        }
        
        .rfq-schedule-grid {
            display: grid;
            grid-template-columns: auto 1fr auto 1fr;
            gap: 15px;
            align-items: center;
        }
        .rfq-schedule-item {
            display: contents;
        }
        .rfq-schedule-label {
            font-size: 0.8rem;
            color: #9ca3af;
            font-weight: 500;
        }
        .rfq-schedule-value {
            font-size: 0.9rem;
            font-weight: 500;
            color: #1f2937;
        }
        
        .rfq-service-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .rfq-service-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .rfq-service-name {
            font-size: 0.85rem;
            color: #4b5563;
            min-width: 180px;
        }
        .rfq-service-check {
            font-size: 1rem;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .rfq-service-check.checked {
            color: #10b981;
        }
        .rfq-service-check.unchecked {
            color: #ef4444;
        }
        .rfq-service-address {
            font-size: 0.85rem;
            color: #3b82f6;
            flex: 1;
        }
        .rfq-service-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .rfq-cargo-summary {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1f2937;
            padding: 10px 0;
        }
        
        .rfq-info-messages {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .rfq-info-messages p {
            font-size: 0.8rem;
            color: #6b7280;
            margin: 5px 0;
            line-height: 1.5;
        }
        
        .rfq-action-buttons {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: nowrap;
        }
        .rfq-btn {
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .rfq-btn-edit {
            background: #eff6ff;
            color: #3b82f6;
            border: 1px solid #bfdbfe;
        }
        .rfq-btn-edit:hover {
            background: #dbeafe;
        }
        .rfq-btn-support {
            background: #ffffff;
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }
        .rfq-btn-support:hover {
            background: #eff6ff;
        }
        .rfq-btn-pdf {
            background: #ef4444;
            color: white;
        }
        .rfq-btn-pdf:hover {
            background: #dc2626;
        }
        .rfq-btn-booking {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        .rfq-btn-booking:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        .rfq-btn-booking:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        @media (max-width: 768px) {
            .rfq-modal-content {
                padding: 20px;
            }
            .rfq-grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            .rfq-schedule-grid {
                grid-template-columns: auto 1fr;
            }
            .rfq-action-buttons {
                flex-wrap: wrap;
                gap: 8px;
            }
            .rfq-btn {
                flex: 1 1 45%;
                justify-content: center;
                min-width: 140px;
            }
        }

        /* Autocomplete Styles */
        .autocomplete-wrapper {
            position: relative;
        }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--accent-color);
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 280px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .autocomplete-dropdown.show {
            display: block;
        }
        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.15s ease;
        }
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background: rgba(59, 130, 246, 0.15);
        }
        .autocomplete-item .port-code {
            font-weight: 700;
            color: var(--accent-color);
            font-size: 0.95rem;
        }
        .autocomplete-item .port-name {
            color: var(--text-main);
            font-size: 0.85rem;
            margin-left: 8px;
        }
        .autocomplete-item .port-country {
            color: var(--text-sub);
            font-size: 0.75rem;
            display: block;
            margin-top: 2px;
        }
        .autocomplete-item .port-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 6px;
        }
        .autocomplete-item .port-type.air {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }
        .autocomplete-item .port-type.ocean {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        .autocomplete-no-results {
            padding: 15px;
            text-align: center;
            color: var(--text-sub);
            font-size: 0.85rem;
        }
        .autocomplete-loading {
            padding: 15px;
            text-align: center;
            color: var(--text-sub);
        }
        .autocomplete-loading::after {
            content: '';
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid var(--text-sub);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            margin-left: 8px;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
        }

        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; }
            .grid-4, .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .cargo-row { grid-template-columns: 1fr; gap: 5px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        }
    </style>
    <script src="../js/features/ai-assistant.js"></script>
</head>
<body>
    <!-- Header -->
    <header>
        <a href="/" class="logo">
            AAL<span>.</span>
            <div class="full-name">All About Logistics</div>
        </a>
        <nav>
            <ul>
                <li><a href="quotation.html" class="active">Quotation</a></li>
                <li><a href="shipper-bidding.html">My Quotations</a></li>
                <li><a href="bidding-list.html">Bidding</a></li>
                <li><a href="market-data.html">Market Data</a></li>
                <li><a href="news-intelligence.html">News Intel</a></li>
                <li><a href="../ai_studio_code_F2.html#tools">Tools</a></li>
                <li><a href="report-insight.html">Report & Insight</a></li>
                <li><a href="dashboard-shipper.html">Dashboard</a></li>
            </ul>
        </nav>
        <!-- Auth Container -->
        <div class="header-auth" id="headerAuthContainer">
            <button class="header-auth-btn" onclick="Auth.openModal()">
                <i class="fas fa-sign-in-alt"></i> 로그인
            </button>
        </div>
    </header>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>Submitting your quote request...</div>
        </div>
    </div>
    
    <!-- Toast Message -->
    <div class="toast" id="toast"></div>
    
    <!-- Success Modal -->
    <div class="success-modal" id="success-modal">
        <div class="rfq-modal-content">
            <!-- Header -->
            <div class="rfq-modal-header">
                <div class="rfq-header-info">
                    <span class="rfq-bidding-no">Bidding No(<span id="modal-bidding-no">-</span>)</span>
                    <span class="rfq-deadline">Deadline: <span id="modal-deadline">-</span></span>
                </div>
                <button class="rfq-close-btn" onclick="closeSuccessModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Title -->
            <h2 class="rfq-modal-title">Thank you for your quotation request!</h2>
            
            <!-- Customer Section -->
            <div class="rfq-section">
                <div class="rfq-grid-4">
                    <div class="rfq-field">
                        <div class="rfq-field-label">Customer</div>
                        <div class="rfq-field-value" id="modal-customer">-</div>
                    </div>
                    <div class="rfq-field">
                        <div class="rfq-field-label">Name</div>
                        <div class="rfq-field-value" id="modal-name">-</div>
                    </div>
                    <div class="rfq-field">
                        <div class="rfq-field-label">E-mail</div>
                        <div class="rfq-field-value" id="modal-email">-</div>
                    </div>
                    <div class="rfq-field">
                        <div class="rfq-field-label">Phone</div>
                        <div class="rfq-field-value" id="modal-phone">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Quotation Details Section -->
            <div class="rfq-section">
                <div class="rfq-section-title">Quotation Details</div>
                <div class="rfq-details-row">
                    <div class="rfq-detail-item">
                        <span class="rfq-detail-label">Trade Type</span>
                        <span class="rfq-detail-value" id="modal-trade-type">-</span>
                    </div>
                    <div class="rfq-detail-item">
                        <span class="rfq-detail-label">Shipping Mode</span>
                        <span class="rfq-detail-value" id="modal-shipping-mode">-</span>
                    </div>
                    <div class="rfq-detail-item">
                        <span class="rfq-detail-label">Incoterms</span>
                        <span class="rfq-detail-value" id="modal-incoterms">-</span>
                    </div>
                    <div class="rfq-detail-item">
                        <span class="rfq-detail-label">Load Type</span>
                        <span class="rfq-detail-value" id="modal-load-type">-</span>
                    </div>
                    <div class="rfq-detail-item">
                        <span class="rfq-detail-label">DG</span>
                        <span class="rfq-detail-value" id="modal-dg">N</span>
                    </div>
                </div>
            </div>
            
            <!-- Shipping Schedule Section -->
            <div class="rfq-section">
                <div class="rfq-section-title">Shipping Schedule</div>
                <div class="rfq-schedule-grid">
                    <div class="rfq-schedule-item">
                        <span class="rfq-schedule-label">POL</span>
                        <span class="rfq-schedule-value" id="modal-pol">-</span>
                    </div>
                    <div class="rfq-schedule-item">
                        <span class="rfq-schedule-label">ETD</span>
                        <span class="rfq-schedule-value" id="modal-etd">-</span>
                    </div>
                    <div class="rfq-schedule-item">
                        <span class="rfq-schedule-label">POD</span>
                        <span class="rfq-schedule-value" id="modal-pod">-</span>
                    </div>
                    <div class="rfq-schedule-item">
                        <span class="rfq-schedule-label">ETA</span>
                        <span class="rfq-schedule-value" id="modal-eta">-</span>
                    </div>
                </div>
            </div>
            
            <!-- Additional Details Section -->
            <div class="rfq-section">
                <div class="rfq-section-title">Additional Details</div>
                <div class="rfq-service-grid" id="modal-additional-details">
                    <!-- Dynamically populated based on form visibility -->
                </div>
            </div>
            
            <!-- Cargo Details Section -->
            <div class="rfq-section">
                <div class="rfq-section-title">Cargo Details</div>
                <div class="rfq-cargo-summary" id="modal-cargo-details">-</div>
            </div>
            
            <!-- Info Messages -->
            <div class="rfq-info-messages">
                <p>※ Your quotation will be provided in real time, and you'll be notified once it's ready</p>
                <p>※ For urgent or detailed inquiries, contact our representative below for real-time support.</p>
            </div>
            
            <!-- Action Buttons -->
            <div class="rfq-action-buttons">
                <button class="rfq-btn rfq-btn-edit" onclick="closeSuccessModal()">Edit</button>
                <button class="rfq-btn rfq-btn-support">Connect to Support</button>
                <button class="rfq-btn rfq-btn-pdf" id="btn-download-pdf" onclick="downloadPDF()">
                    <i class="fas fa-file-pdf"></i> Download PDF
                </button>
                <a href="bidding-list.html" class="rfq-btn rfq-btn-booking">Go to Bidding List</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Left: Form -->
        <main>
            <h2>Quick Quote Request</h2>
            
            <!-- Validation Error Container -->
            <div class="validation-error" id="validation-error">
                <div class="validation-error-title">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Please fix the following errors:</span>
                </div>
                <ul class="validation-error-list" id="validation-error-list"></ul>
            </div>

            <!-- Trade Mode -->
            <div class="section">
                <div class="section-header">Trade Mode <i class="far fa-question-circle info-icon"></i></div>
                <div class="grid-3">
                    <div class="option-card active" id="trade-export" onclick="setTrade('export')">
                        <div class="icon-box">E</div>
                        <span>Export (수출)</span>
                    </div>
                    <div class="option-card" id="trade-import" onclick="setTrade('import')">
                        <div class="icon-box" style="background:#555;">I</div>
                        <span>Import (수입)</span>
                    </div>
                    <div class="option-card" id="trade-domestic" onclick="setTrade('domestic')">
                        <div class="icon-box" style="background:#555;">D</div>
                        <span>Domestic (국내)</span>
                    </div>
                </div>
            </div>

            <!-- Shipping Type -->
            <div class="section" id="shipping-type-section">
                <div class="section-header">Shipping Type <i class="far fa-question-circle info-icon"></i></div>
                <div class="grid-4" id="shipping-type-grid">
                    <div class="option-card" id="ship-all" onclick="setShip('all')"><i class="fas fa-infinity"></i> All</div>
                    <div class="option-card active" id="ship-ocean" onclick="setShip('ocean')"><i class="fas fa-ship"></i> Ocean</div>
                    <div class="option-card" id="ship-air" onclick="setShip('air')"><i class="fas fa-plane"></i> Air</div>
                    <div class="option-card" id="ship-truck" onclick="setShip('truck')"><i class="fas fa-truck"></i> Trucking</div>
                </div>
            </div>

            <!-- Load Type -->
            <div class="section" id="load-type-section">
                <div class="section-header">Load Type <i class="far fa-question-circle info-icon"></i></div>
                <div class="grid-3" id="load-type-container">
                    <!-- Dynamic Content via JS -->
                </div>
            </div>

            <!-- Cargo Details (Phase 1 - 필수 입력) -->
            <div class="section" id="cargo-details-section">
                <div class="section-header">Cargo Details <i class="far fa-question-circle info-icon"></i> 
                    <button class="btn-add-row" id="btn-add-cargo" onclick="addCargoRow()" style="margin-left:auto;">
                        <i class="fas fa-plus"></i> Add
                    </button>
                    <span class="row-counter" id="row-counter">1 / 10</span>
                </div>
                
                <div id="cargo-input-area">
                    <!-- FCL INPUT VIEW -->
                    <div id="fcl-view">
                        <div id="fcl-rows">
                            <div class="cargo-row" data-row-index="0">
                                <div class="input-group"><label>Container Type</label><select class="form-input fcl-type"></select></div>
                                <div class="input-group"><label>Gross Weight(KG) <span class="text-red">*</span></label><input type="text" class="form-input number-format fcl-weight" placeholder="0.00" inputmode="decimal" maxlength="10"></div>
                                <div class="input-group"><label>Measures(CBM)</label><input type="text" class="form-input number-format fcl-cbm" placeholder="0.00" inputmode="decimal" maxlength="10"></div>
                                <div class="input-group"><label>Qty</label><input type="text" class="form-input number-format fcl-qty" value="1" inputmode="numeric" maxlength="10"></div>
                                <i class="fas fa-minus-circle row-delete disabled" onclick="deleteCargoRow(this)"></i>
                            </div>
                        </div>
                    </div>

                    <!-- LCL INPUT VIEW -->
                    <div id="lcl-view" style="display:none;">
                        <div id="lcl-rows">
                            <div class="cargo-row" data-row-index="0" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 40px; align-items: end;">
                                <div class="input-group">
                                    <label>Length <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(CM)</span></label>
                                    <input type="text" class="form-input lcl-calc-trigger number-format lcl-l" placeholder="0" inputmode="numeric" maxlength="3">
                                </div>
                                <div class="input-group">
                                    <label>Width <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(CM)</span></label>
                                    <input type="text" class="form-input lcl-calc-trigger number-format lcl-w" placeholder="0" inputmode="numeric" maxlength="3">
                                </div>
                                <div class="input-group">
                                    <label>Height <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(CM)</span></label>
                                    <input type="text" class="form-input lcl-calc-trigger number-format lcl-h" placeholder="0" inputmode="numeric" maxlength="3">
                                </div>
                                <div class="input-group">
                                    <label>Pkg Qty <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(PCS)</span></label>
                                    <input type="text" class="form-input lcl-calc-trigger number-format lcl-qty" value="1" inputmode="numeric" maxlength="10">
                                </div>
                                <div class="input-group">
                                    <label>Gross Weight <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(KG/Per Pkg)</span></label>
                                    <input type="text" class="form-input lcl-calc-trigger number-format-int lcl-gross-weight" placeholder="0" inputmode="numeric" maxlength="10">
                                </div>
                                <div class="input-group">
                                    <label>CBM<br><span style="font-size:0.75rem; color:#888;">(M³/Per Pkg)</span></label>
                                    <input type="text" class="form-input lcl-cbm" readonly value="0.0" style="font-weight:600; color:var(--accent-color);">
                                </div>
                                <i class="fas fa-minus-circle row-delete disabled" onclick="deleteCargoRow(this)"></i>
                            </div>
                        </div>
                    </div>

                    <!-- AIR INPUT VIEW -->
                    <div id="air-view" style="display:none;">
                        <div id="air-rows">
                            <div class="cargo-row" data-row-index="0" style="grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 40px; align-items: end;">
                                <div class="input-group">
                                    <label>Length <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(CM)</span></label>
                                    <input type="text" class="form-input air-calc-trigger number-format air-l" placeholder="0" inputmode="numeric" maxlength="3">
                                </div>
                                <div class="input-group">
                                    <label>Width <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(CM)</span></label>
                                    <input type="text" class="form-input air-calc-trigger number-format air-w" placeholder="0" inputmode="numeric" maxlength="3">
                                </div>
                                <div class="input-group">
                                    <label>Height <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(CM)</span></label>
                                    <input type="text" class="form-input air-calc-trigger number-format air-h" placeholder="0" inputmode="numeric" maxlength="3">
                                </div>
                                <div class="input-group">
                                    <label>Pkg Qty <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(PCS)</span></label>
                                    <input type="text" class="form-input air-calc-trigger number-format air-qty" value="1" inputmode="numeric" maxlength="10">
                                </div>
                                <div class="input-group">
                                    <label>Gross Weight <span class="text-red">*</span><br><span style="font-size:0.75rem; color:#888;">(KG/Per Pkg)</span></label>
                                    <input type="text" class="form-input air-calc-trigger number-format-int air-gross-weight" placeholder="0" inputmode="numeric" maxlength="10">
                                </div>
                                <div class="input-group">
                                    <label>Volume Weight<br><span style="font-size:0.75rem; color:#888;">(KG/Per Pkg)</span></label>
                                    <input type="text" class="form-input air-volume-weight" readonly value="0">
                                </div>
                                <div class="input-group">
                                    <label>Chargeable Weight<br><span style="font-size:0.75rem; color:#888;">(KG/Per Pkg)</span></label>
                                    <input type="text" class="form-input air-chargeable-weight" readonly value="0" style="font-weight:600; color:var(--accent-color);">
                                </div>
                                <i class="fas fa-minus-circle row-delete disabled" onclick="deleteCargoRow(this)"></i>
                            </div>
                        </div>
                    </div>

                    <!-- FTL INPUT VIEW (Trucking) -->
                    <div id="ftl-view" style="display:none;">
                        <div id="ftl-rows">
                            <div class="cargo-row" data-row-index="0" style="grid-template-columns: 1fr 1fr 40px;">
                                <div class="input-group">
                                    <label>Truck Type</label>
                                    <select class="form-input ftl-type">
                                        <option>1 Ton Truck</option>
                                        <option>2.5 Ton Truck</option>
                                        <option>5 Ton Truck</option>
                                        <option>11 Ton Truck</option>
                                        <option>25 Ton Truck</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label>Truck Qty</label>
                                    <input type="text" class="form-input number-format ftl-qty" value="1" inputmode="numeric" maxlength="10">
                                </div>
                                <i class="fas fa-minus-circle row-delete disabled" onclick="deleteCargoRow(this)"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="checkbox-wrapper" id="dg-checkbox-wrapper">
                    <input type="checkbox" id="dg-check" onchange="toggleDG(this.checked)" style="accent-color: var(--accent-color);">
                    <label for="dg-check">Cargo is considered as dangerous goods</label>
                </div>

                <div class="grid-2" id="dg-inputs" style="display:none;">
                    <div class="input-group"><label>DG Class</label><input type="text" class="form-input" id="dg-class" placeholder="e.g. 3" maxlength="1"></div>
                    <div class="input-group"><label>UN Number</label><input type="text" class="form-input" id="dg-un" placeholder="e.g. 1203" maxlength="4"></div>
                </div>

                <!-- Reefer Temperature Section -->
                <div class="reefer-temp-section" id="reefer-temp-section">
                    <div class="reefer-input-group">
                        <label><i class="fas fa-thermometer-half"></i> Storage Temperature</label>
                        <div class="temp-input-wrapper">
                            <input type="text" class="form-input temp-input" id="temp-min" placeholder="Min" maxlength="5">
                            <span class="temp-separator">~</span>
                            <input type="text" class="form-input temp-input" id="temp-max" placeholder="Max" maxlength="5">
                        </div>
                    </div>
                    <div class="reefer-input-group">
                        <label>Unit</label>
                        <div class="temp-unit-toggle">
                            <button type="button" class="temp-unit-btn active" data-unit="C" onclick="setTempUnit('C')">°C</button>
                            <button type="button" class="temp-unit-btn" data-unit="F" onclick="setTempUnit('F')">°F</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shipping Schedules -->
            <div class="section">
                <div class="section-header" id="schedules-header">Shipping Schedules <i class="far fa-question-circle info-icon"></i></div>
                <div class="grid-2" style="margin-bottom: 1rem;">
                    <div class="input-group">
                        <label id="label-pol">Port of Loading <span class="text-red">*</span></label>
                        <div class="autocomplete-wrapper">
                            <div class="icon-input-wrapper">
                                <i class="fas fa-map-marker-alt"></i>
                                <input type="text" class="form-input port-autocomplete" id="input-pol" placeholder="Origin Port / City" maxlength="50" autocomplete="off">
                            </div>
                            <div class="autocomplete-dropdown" id="dropdown-pol"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-sub); margin-top:4px;">From</div>
                    </div>
                    <div class="input-group">
                        <label id="label-pod">Port of Discharging <span class="text-red">*</span></label>
                        <div class="autocomplete-wrapper">
                            <div class="icon-input-wrapper">
                                <i class="fas fa-map-marker-alt"></i>
                                <input type="text" class="form-input port-autocomplete" id="input-pod" placeholder="Destination Port / City" maxlength="50" autocomplete="off">
                            </div>
                            <div class="autocomplete-dropdown" id="dropdown-pod"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-sub); margin-top:4px;">To</div>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="input-group">
                        <label>Estimated Departure <span class="text-red">*</span></label>
                        <div class="icon-input-wrapper">
                            <i class="far fa-calendar"></i>
                            <div class="date-input-group" id="etd-input-group">
                                <input type="text" class="date-year" id="etd-year" placeholder="YYYY" maxlength="4" inputmode="numeric">
                                <span class="date-separator">/</span>
                                <input type="text" class="date-month" id="etd-month" placeholder="MM" maxlength="2" inputmode="numeric">
                                <span class="date-separator">/</span>
                                <input type="text" class="date-day" id="etd-day" placeholder="DD" maxlength="2" inputmode="numeric">
                                <span class="time-fields" id="etd-time-fields">
                                    <span class="date-separator">/</span>
                                    <input type="text" class="date-hour" id="etd-hour" placeholder="HH" maxlength="2" inputmode="numeric">
                                    <span class="date-separator">:</span>
                                    <input type="text" class="date-minute" id="etd-minute" placeholder="MM" maxlength="2" inputmode="numeric">
                                </span>
                            </div>
                            <input type="hidden" id="input-etd">
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-sub); margin-top:4px;">ETD</div>
                        <div class="date-error-message" id="etd-error" style="display:none;"><i class="fas fa-exclamation-circle"></i><span></span></div>
                    </div>
                    <div class="input-group">
                        <label>Estimated Arrival <span class="text-red">*</span></label>
                        <div class="icon-input-wrapper">
                            <i class="far fa-calendar"></i>
                            <div class="date-input-group" id="eta-input-group">
                                <input type="text" class="date-year" id="eta-year" placeholder="YYYY" maxlength="4" inputmode="numeric">
                                <span class="date-separator">/</span>
                                <input type="text" class="date-month" id="eta-month" placeholder="MM" maxlength="2" inputmode="numeric">
                                <span class="date-separator">/</span>
                                <input type="text" class="date-day" id="eta-day" placeholder="DD" maxlength="2" inputmode="numeric">
                                <span class="time-fields" id="eta-time-fields">
                                    <span class="date-separator">/</span>
                                    <input type="text" class="date-hour" id="eta-hour" placeholder="HH" maxlength="2" inputmode="numeric">
                                    <span class="date-separator">:</span>
                                    <input type="text" class="date-minute" id="eta-minute" placeholder="MM" maxlength="2" inputmode="numeric">
                                </span>
                            </div>
                            <input type="hidden" id="input-eta">
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-sub); margin-top:4px;">ETA</div>
                        <div class="date-error-message" id="eta-error" style="display:none;"><i class="fas fa-exclamation-circle"></i><span></span></div>
                    </div>
                </div>
            </div>

            <!-- Quick Quotation Result -->
            <div class="quick-quote-section" id="quick-quote-section">
                <div class="section-header">
                    Estimated Freight 
                    <i class="far fa-question-circle info-icon" title="POL, POD, Container Type을 기반으로 예상 운임을 계산합니다."></i>
                </div>
                <div class="quick-quote-card" id="quick-quote-card">
                    <div class="quick-quote-badge" id="quick-quote-badge">QUICK QUOTATION</div>
                    
                    <!-- Loading State -->
                    <div class="quick-quote-loading" id="quick-quote-loading" style="display:none;">
                        <i class="fas fa-spinner"></i>
                        <span>운임 조회 중...</span>
                    </div>
                    
                    <!-- Available State -->
                    <div id="quick-quote-content" style="display:none;">
                        <!-- 예상 총 비용 (상단 표시) -->
                        <div class="quick-quote-total-section">
                            <div class="quick-quote-total-krw">
                                <span class="quick-quote-total-krw-label">예상 총 비용</span>
                                <span class="quick-quote-total-krw-value" id="quick-quote-total-krw">₩0</span>
                            </div>
                            <div class="quick-quote-meta">
                                <span><i class="fas fa-ship"></i> <strong id="quick-quote-carrier">-</strong></span>
                                <span>Valid: <span id="quick-quote-validity">-</span></span>
                            </div>
                        </div>
                        
                        <!-- 상세 보기 토글 버튼 -->
                        <button type="button" class="btn-breakdown-toggle" id="btn-breakdown-toggle" onclick="toggleQuoteBreakdown()">
                            <i class="fas fa-chevron-down" id="breakdown-toggle-icon"></i>
                            <span id="breakdown-toggle-text">상세 보기</span>
                        </button>
                        
                        <!-- 상세 내역 (접힌 상태) -->
                        <div class="quick-quote-breakdown vertical" id="quick-quote-breakdown" style="display:none;">
                            <!-- Step 1: Origin Local Charges (출발지 비용) -->
                            <div class="quick-quote-group">
                                <div class="quick-quote-group-header">
                                    <span class="quick-quote-step">1</span>
                                    <div class="quick-quote-group-title">
                                        <i class="fas fa-warehouse"></i> Origin Local Charges
                                        <span class="quick-quote-group-subtitle">출발지 비용</span>
                                    </div>
                                </div>
                                <div id="quick-quote-local-items" class="quick-quote-items-list"></div>
                                <div class="quick-quote-subtotal">
                                    <span class="quick-quote-subtotal-label">Subtotal</span>
                                    <span class="quick-quote-subtotal-value" id="quick-quote-local-subtotal">₩0</span>
                                </div>
                            </div>
                            
                            <!-- Step 2: Ocean Freight (해상운임) -->
                            <div class="quick-quote-group">
                                <div class="quick-quote-group-header">
                                    <span class="quick-quote-step">2</span>
                                    <div class="quick-quote-group-title">
                                        <i class="fas fa-ship"></i> Ocean Freight
                                        <span class="quick-quote-group-subtitle">해상운임</span>
                                    </div>
                                </div>
                                <div id="quick-quote-ocean-items" class="quick-quote-items-list"></div>
                                <div class="quick-quote-subtotal">
                                    <span class="quick-quote-subtotal-label">Subtotal</span>
                                    <span class="quick-quote-subtotal-value" id="quick-quote-ocean-subtotal">$0</span>
                                </div>
                            </div>
                            
                            <!-- Step 3: Additional Services (추가 서비스) - 선택 시에만 표시 -->
                            <div class="quick-quote-group" id="quick-quote-additional" style="display:none;">
                                <div class="quick-quote-group-header">
                                    <span class="quick-quote-step">3</span>
                                    <div class="quick-quote-group-title">
                                        <i class="fas fa-plus-square"></i> Additional Services
                                        <span class="quick-quote-group-subtitle">추가 서비스</span>
                                    </div>
                                </div>
                                <div id="quick-quote-additional-items" class="quick-quote-items-list"></div>
                                <div class="quick-quote-subtotal">
                                    <span class="quick-quote-subtotal-label">Subtotal</span>
                                    <span class="quick-quote-subtotal-value" id="quick-quote-additional-subtotal">₩0</span>
                                </div>
                            </div>
                            
                            <!-- 통화별 합계 -->
                            <div class="quick-quote-total-breakdown">
                                <span class="quick-quote-total-label">
                                    <i class="fas fa-calculator"></i> 통화별 합계
                                </span>
                                <span class="quick-quote-total-value" id="quick-quote-total">$0 + ₩0</span>
                            </div>
                        </div>
                        
                        <div class="quick-quote-note">
                            <i class="fas fa-info-circle"></i>
                            <span id="quick-quote-note">위 금액은 예상 견적으로 실제 금액은 비딩 결과에 따라 달라질 수 있습니다.</span>
                        </div>
                    </div>
                    
                    <!-- Unavailable State -->
                    <div class="quick-quote-unavailable-msg" id="quick-quote-unavailable" style="display:none;">
                        <h4><i class="fas fa-exclamation-triangle"></i> <span id="quick-quote-unavailable-title">실시간 견적 불가</span></h4>
                        <p id="quick-quote-unavailable-msg">해당 구간은 실시간 견적을 제공하지 않습니다.</p>
                        <p id="quick-quote-available-period" style="display:none; margin-top: 10px; padding: 10px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; color: var(--accent-color);">
                            <i class="fas fa-info-circle"></i> <span id="quick-quote-available-period-text"></span>
                        </p>
                        <p style="margin-top: 10px; color: var(--text-sub);">견적 요청을 통해 포워더 비딩을 진행해 주세요.</p>
                    </div>
                </div>
            </div>

            <!-- Detailed Quote Request Button (Estimated Freight 출력 후에만 표시) -->
            <div class="section" id="detailed-quote-btn-section" style="display:none;">
                <button type="button" class="btn-detailed-quote" id="btn-detailed-quote" onclick="toggleDetailedQuoteSection()">
                    <i class="fas fa-plus-circle" id="btn-detailed-icon"></i> 
                    <span id="btn-detailed-text">상세 견적 요청</span>
                </button>
            </div>

            <!-- Phase 2: Detailed Quote Section (Initially Hidden) -->
            <div id="detailed-quote-section" style="display:none;">

            <!-- Additional Details -->
            <div class="section" id="additional-details-section">
                <div class="section-header">Additional Details <i class="far fa-question-circle info-icon"></i></div>
                
                <div class="detail-row" id="row-export-cc">
                    <label>Export Customs Clearance</label>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="export-cc" value="yes" onchange="updateSummary(); updateAdditionalCosts()"> Required</label>
                        <label class="radio-label checked"><input type="radio" name="export-cc" value="no" checked onchange="updateSummary(); updateAdditionalCosts()"> No</label>
                    </div>
                </div>
                <div class="detail-row" id="row-import-cc">
                    <label>Import Customs Clearance</label>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="import-cc" value="yes" onchange="updateSummary()"> Required</label>
                        <label class="radio-label checked"><input type="radio" name="import-cc" value="no" checked onchange="updateSummary()"> No</label>
                    </div>
                </div>
                <div class="detail-row" id="row-shipping-insurance">
                    <label>Shipping Insurance</label>
                    <div class="radio-group">
                        <label class="radio-label"><input type="radio" name="ship-insurance" value="yes" onchange="updateSummary()"> Required</label>
                        <label class="radio-label checked"><input type="radio" name="ship-insurance" value="no" checked onchange="updateSummary()"> No</label>
                    </div>
                </div>
                
                <div class="detail-row" id="row-pickup" style="align-items: flex-start;">
                    <label style="padding-top:10px;">Pickup</label>
                    <div style="width:100%;">
                        <div class="radio-group" style="margin-bottom:10px;">
                            <label class="radio-label"><input type="radio" name="pickup" value="yes" onchange="toggleAddr('pickup-addr', true); updateAdditionalCosts()"> Required</label>
                            <label class="radio-label checked"><input type="radio" name="pickup" value="no" checked onchange="toggleAddr('pickup-addr', false); updateAdditionalCosts()"> No</label>
                        </div>
                        <div class="input-group" id="pickup-addr-group" style="display:none;">
                            <label>Address <span class="text-red">*</span></label>
                            <input type="text" class="form-input" id="pickup-addr" placeholder="Full Pickup Address" maxlength="100" onblur="updateAdditionalCosts()">
                        </div>
                    </div>
                </div>

                <div class="detail-row" id="row-delivery" style="align-items: flex-start;">
                    <label style="padding-top:10px;">Delivery</label>
                    <div style="width:100%;">
                        <div class="radio-group" style="margin-bottom:10px;">
                            <label class="radio-label"><input type="radio" name="delivery" value="yes" onchange="toggleAddr('delivery-addr', true)"> Required</label>
                            <label class="radio-label checked"><input type="radio" name="delivery" value="no" checked onchange="toggleAddr('delivery-addr', false)"> No</label>
                        </div>
                        <div class="input-group" id="delivery-addr-group" style="display:none;">
                            <label>Address <span class="text-red">*</span></label>
                            <input type="text" class="form-input" id="delivery-addr" placeholder="Full Delivery Address" maxlength="100">
                        </div>
                    </div>
                </div>

                <div class="detail-row" id="row-invoice">
                    <label>Invoice Value(USD) <span class="text-red">*</span></label>
                    <div class="input-group" style="width: 200px;">
                        <input type="text" class="form-input number-format" id="invoice-val" placeholder="0" inputmode="numeric" maxlength="20">
                    </div>
                </div>
            </div>

            <!-- Incoterms (Phase 2) -->
            <div class="section" id="incoterms-section">
                <div class="section-header">Incoterms <i class="far fa-question-circle info-icon" title="Terms of Sale - 비딩 시 명시됩니다"></i></div>
                <div class="grid-3" id="incoterm-container">
                    <div class="incoterm-card" onclick="setInco(this, 'EXW')"><div class="title">EXW</div><div class="desc">Ex Works<br>Only responsible until goods leave factory.</div></div>
                    <div class="incoterm-card active" onclick="setInco(this, 'FOB')"><div class="title">FOB</div><div class="desc">Free-on Board<br>Costs until loaded at origin.</div></div>
                    <div class="incoterm-card" onclick="setInco(this, 'CFR')"><div class="title">CFR</div><div class="desc">Cost and Freight<br>Pays transport to destination.</div></div>
                    <div class="incoterm-card" onclick="setInco(this, 'CIF')"><div class="title">CIF</div><div class="desc">Cost, Insurance & Freight<br>Pays freight + insurance.</div></div>
                    <div class="incoterm-card" onclick="setInco(this, 'DAP')"><div class="title">DAP</div><div class="desc">Delivered at Place<br>Ships to buyer's location.</div></div>
                    <div class="incoterm-card" onclick="setInco(this, 'DDP')"><div class="title">DDP</div><div class="desc">Delivered Duty Paid<br>Handles everything + duties.</div></div>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="section">
                <div class="section-header">Customer Information <i class="far fa-question-circle info-icon"></i></div>
                <div class="grid-3" style="margin-bottom: 1rem;">
                    <div class="input-group"><label>Company Name <span class="text-red">*</span></label><input type="text" class="form-input" id="c-company" placeholder="Company Name" maxlength="50"></div>
                    <div class="input-group"><label>Job Title</label><input type="text" class="form-input" id="c-title" placeholder="Position" maxlength="30"></div>
                    <div class="input-group"><label>Name <span class="text-red">*</span></label><input type="text" class="form-input" id="c-name" placeholder="Full Name" maxlength="30"></div>
                </div>
                <div class="grid-2">
                    <div class="input-group"><label>E-mail <span class="text-red">*</span></label><input type="email" class="form-input" id="c-email" placeholder="email@example.com" maxlength="30"></div>
                    <div class="input-group"><label>Phone <span class="text-red">*</span></label><input type="tel" class="form-input" id="c-phone" placeholder="Phone Number" maxlength="30"></div>
                </div>
            </div>

            <!-- Remark -->
            <div class="section" id="remark-section">
                <div class="section-header">Remark <span id="remark-required" class="text-red" style="display:none;">*</span> <i class="far fa-question-circle info-icon"></i></div>
                <div id="remark-helper" class="remark-helper" style="display:none;"></div>
                <textarea class="form-input" id="remark-textarea" style="height: 100px; resize: none;" placeholder="Any special instructions..." maxlength="500"></textarea>
                <div id="all-notice" class="remark-helper" style="display:none; margin-top:10px; background:rgba(234, 179, 8, 0.1); border-color:#eab308; color:#eab308;">
                    ※ A quotation is required for FCL, LCL, BULK, and Air freight
                </div>
            </div>

            </div><!-- End of Phase 2: detailed-quote-section -->

        </main>

        <!-- Right: Summary -->
        <aside>
            <div class="summary-card">
                <div class="mode-toggle">
                    Quote Mode <span style="margin-left:10px;" class="active"><i class="fas fa-check-circle"></i> Quick</span> <span style="color:#666; margin-left:5px;"><i class="far fa-circle"></i> Guided</span>
                </div>
                <div class="summary-box">
                    <div class="summary-title">Quote Summary</div>
                    <ul class="summary-list">
                        <li>
                            <span class="s-label">Trade Mode</span>
                            <span class="s-value" id="s-trade">Export</span>
                        </li>
                        <li>
                            <span class="s-label">Shipping Type</span>
                            <span class="s-value" id="s-ship">Ocean</span>
                        </li>
                        <li>
                            <span class="s-label">Load Type</span>
                            <span class="s-value" id="s-load">FCL</span>
                        </li>
                        <li>
                            <span class="s-label">Cargo Details</span>
                            <span class="s-value" id="s-cargo">-</span>
                        </li>
                        <li>
                            <span class="s-label" id="s-schedule-label">Shipping Schedules</span>
                            <span class="s-value" id="s-schedule">- <br> -</span>
                        </li>
                        <li>
                            <span class="s-label">Additional Details</span>
                            <span class="s-value" id="s-add">-</span>
                        </li>
                        <li>
                            <span class="s-label">Incoterms</span>
                            <span class="s-value" id="s-inco">FOB</span>
                        </li>
                        <li>
                            <span class="s-label">Customer Information</span>
                            <span class="s-value" id="s-cust">-</span>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Footer Actions -->
        <div class="action-buttons">
            <button class="btn btn-secondary">Connect to Support</button>
            <button class="btn btn-primary" onclick="submitQuote()">Submit</button>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:8001';
        
        // State Management
        const state = {
            trade: 'export',
            ship: 'ocean',
            incoterms: 'FOB',
            load: 'FCL',
            containerTypes: [],  // Container types from API
            quickQuotation: null  // Quick Quotation 결과 저장
        };

        // ==========================================
        // QUICK QUOTATION FUNCTIONS
        // ==========================================
        
        /**
         * Quick Quotation API 호출
         * POL, POD, Container Type 기반으로 운임 조회
         */
        async function fetchQuickQuotation() {
            // FCL이 아니면 Quick Quotation 숨김
            if (state.load !== 'FCL' || state.ship !== 'ocean') {
                hideQuickQuotation();
                return;
            }
            
            const pol = document.getElementById('input-pol')?.value?.trim();
            const pod = document.getElementById('input-pod')?.value?.trim();
            const fclRow = document.querySelector('#fcl-rows .cargo-row');
            const containerSelect = fclRow?.querySelector('.fcl-type');
            const containerCode = containerSelect?.options[containerSelect.selectedIndex]?.dataset?.code;
            
            // 필수 값이 없으면 숨김
            if (!pol || !pod || !containerCode) {
                hideQuickQuotation();
                return;
            }
            
            // POL/POD에서 코드만 추출 (예: "KRPUS - BUSAN, KOREA" → "KRPUS")
            const polCode = pol.split(' - ')[0]?.trim();
            const podCode = pod.split(' - ')[0]?.trim();
            
            if (!polCode || !podCode) {
                hideQuickQuotation();
                return;
            }
            
            // ETD 날짜 가져오기 (필수)
            const etdYear = document.getElementById('etd-year')?.value?.trim();
            const etdMonth = document.getElementById('etd-month')?.value?.trim();
            const etdDay = document.getElementById('etd-day')?.value?.trim();
            
            // ETD가 입력되지 않으면 조회하지 않음
            if (!etdYear || !etdMonth || !etdDay) {
                hideQuickQuotation();
                return;
            }
            
            const etd = `${etdYear}-${etdMonth.padStart(2, '0')}-${etdDay.padStart(2, '0')}`;
            
            // Show loading
            showQuickQuotationLoading();
            
            try {
                const params = new URLSearchParams({
                    pol: polCode,
                    pod: podCode,
                    container_type: containerCode
                });
                if (etd) params.append('etd', etd);
                
                const response = await fetch(`${API_BASE_URL}/api/freight/estimate?${params}`);
                const data = await response.json();
                
                state.quickQuotation = data;
                renderQuickQuotation(data);
                
            } catch (error) {
                console.error('[Quick Quotation Error]', error);
                showQuickQuotationUnavailable('API 연결 오류', '운임 정보를 조회할 수 없습니다.');
            }
        }
        
        /**
         * Quick Quotation 결과 렌더링
         */
        function renderQuickQuotation(data) {
            const section = document.getElementById('quick-quote-section');
            const card = document.getElementById('quick-quote-card');
            const badge = document.getElementById('quick-quote-badge');
            const content = document.getElementById('quick-quote-content');
            const unavailable = document.getElementById('quick-quote-unavailable');
            const loading = document.getElementById('quick-quote-loading');
            
            loading.style.display = 'none';
            section.classList.add('show');
            
            // Estimated Freight 섹션으로 스크롤
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            if (data.quick_quotation) {
                // Available
                card.classList.remove('unavailable');
                badge.classList.remove('unavailable');
                badge.textContent = 'QUICK QUOTATION';
                content.style.display = 'block';
                unavailable.style.display = 'none';
                
                // Carrier & Validity
                document.getElementById('quick-quote-carrier').textContent = data.carrier || '-';
                document.getElementById('quick-quote-validity').textContent = 
                    data.valid_from && data.valid_to ? `${data.valid_from} ~ ${data.valid_to}` : '-';
                
                // Origin Local Items (순서 1)
                const localItems = document.getElementById('quick-quote-local-items');
                localItems.innerHTML = '';
                if (data.origin_local?.items) {
                    data.origin_local.items.forEach(item => {
                        localItems.innerHTML += renderFreightItem(item);
                    });
                }
                
                // Local subtotal (여러 통화 표시)
                let localSubtotal = [];
                if (data.origin_local?.subtotal_usd > 0) localSubtotal.push(formatCurrency(data.origin_local.subtotal_usd, 'USD'));
                if (data.origin_local?.subtotal_krw > 0) localSubtotal.push(formatCurrency(data.origin_local.subtotal_krw, 'KRW'));
                if (data.origin_local?.subtotal_eur > 0) localSubtotal.push(formatCurrency(data.origin_local.subtotal_eur, 'EUR'));
                document.getElementById('quick-quote-local-subtotal').textContent = localSubtotal.join(' + ') || '₩0';

                // Ocean Freight Items (순서 2)
                const oceanItems = document.getElementById('quick-quote-ocean-items');
                oceanItems.innerHTML = '';
                if (data.ocean_freight?.items) {
                    data.ocean_freight.items.forEach(item => {
                        oceanItems.innerHTML += renderFreightItem(item);
                    });
                }
                document.getElementById('quick-quote-ocean-subtotal').textContent = 
                    formatCurrency(data.ocean_freight?.subtotal_usd || 0, 'USD');
                
                // Total (통화별)
                let totalParts = [];
                if (data.total_usd > 0) totalParts.push(formatCurrency(data.total_usd, 'USD'));
                if (data.total_krw > 0) totalParts.push(formatCurrency(data.total_krw, 'KRW'));
                if (data.total_eur > 0) totalParts.push(formatCurrency(data.total_eur, 'EUR'));
                document.getElementById('quick-quote-total').textContent = totalParts.join(' + ') || '$0';
                
                // Total KRW (환산 총액)
                const totalKrw = data.total_krw_converted || 0;
                document.getElementById('quick-quote-total-krw').textContent = formatCurrency(totalKrw, 'KRW');
                
                // Note
                document.getElementById('quick-quote-note').textContent = data.note || '';
                
            } else {
                // Unavailable
                card.classList.add('unavailable');
                badge.classList.add('unavailable');
                badge.textContent = 'QUOTATION REQUIRED';
                content.style.display = 'none';
                unavailable.style.display = 'block';
                
                document.getElementById('quick-quote-unavailable-title').textContent = 
                    data.message || '실시간 견적 불가';
                document.getElementById('quick-quote-unavailable-msg').textContent = 
                    data.guide || '견적 요청을 통해 포워더 비딩을 진행해 주세요.';
                
                // 유효한 운임 데이터 기간 안내
                const periodEl = document.getElementById('quick-quote-available-period');
                const periodTextEl = document.getElementById('quick-quote-available-period-text');
                if (data.available_from && data.available_to) {
                    periodEl.style.display = 'block';
                    periodTextEl.textContent = `현재 운임 데이터: ${data.available_from} ~ ${data.available_to}`;
                } else {
                    periodEl.style.display = 'none';
                }
            }
            
            // Estimated Freight 출력 후 상세 견적 버튼 표시
            showDetailedQuoteButton();
        }
        
        /**
         * Quick Quotation 로딩 상태 표시
         */
        function showQuickQuotationLoading() {
            const section = document.getElementById('quick-quote-section');
            const content = document.getElementById('quick-quote-content');
            const unavailable = document.getElementById('quick-quote-unavailable');
            const loading = document.getElementById('quick-quote-loading');
            
            section.classList.add('show');
            content.style.display = 'none';
            unavailable.style.display = 'none';
            loading.style.display = 'flex';
        }
        
        /**
         * Quick Quotation 숨김
         */
        function hideQuickQuotation() {
            const section = document.getElementById('quick-quote-section');
            section.classList.remove('show');
            state.quickQuotation = null;
            
            // 버튼과 Phase 2 섹션도 숨김
            hideDetailedQuoteButton();
        }
        
        /**
         * Quick Quotation 불가 상태 표시
         */
        function showQuickQuotationUnavailable(title, message) {
            const section = document.getElementById('quick-quote-section');
            const card = document.getElementById('quick-quote-card');
            const badge = document.getElementById('quick-quote-badge');
            const content = document.getElementById('quick-quote-content');
            const unavailable = document.getElementById('quick-quote-unavailable');
            const loading = document.getElementById('quick-quote-loading');
            
            section.classList.add('show');
            card.classList.add('unavailable');
            badge.classList.add('unavailable');
            badge.textContent = 'QUOTATION REQUIRED';
            content.style.display = 'none';
            unavailable.style.display = 'block';
            loading.style.display = 'none';
            
            document.getElementById('quick-quote-unavailable-title').textContent = title;
            document.getElementById('quick-quote-unavailable-msg').textContent = message;
        }
        
        /**
         * Additional Costs 상태 관리
         */
        const additionalCosts = {
            exportCC: 0,
            pickup: 0
        };
        
        // 고정 비용 설정
        const FIXED_COSTS = {
            exportCC: 50000  // 수출 통관 비용 (KRW)
        };
        
        /**
         * Additional Details 변경 시 추가 비용 업데이트
         */
        async function updateAdditionalCosts() {
            const exportCC = document.querySelector('input[name="export-cc"]:checked')?.value === 'yes';
            const pickup = document.querySelector('input[name="pickup"]:checked')?.value === 'yes';
            const pickupAddr = document.getElementById('pickup-addr')?.value?.trim();
            
            // Reset costs
            additionalCosts.exportCC = 0;
            additionalCosts.pickup = 0;
            
            const additionalSection = document.getElementById('quick-quote-additional');
            const additionalItems = document.getElementById('quick-quote-additional-items');
            
            if (!additionalSection || !additionalItems) return;
            
            let items = [];
            
            // Export CC Cost
            if (exportCC) {
                additionalCosts.exportCC = FIXED_COSTS.exportCC;
                items.push({
                    code: 'EXP CC',
                    name: 'Export Customs Clearance',
                    name_ko: '수출 통관',
                    rate: FIXED_COSTS.exportCC,
                    currency: 'KRW'
                });
            }
            
            // Pickup Trucking Cost
            if (pickup && pickupAddr) {
                const truckingRate = await fetchTruckingRate(pickupAddr);
                if (truckingRate) {
                    additionalCosts.pickup = truckingRate;
                    items.push({
                        code: 'TRUCKING',
                        name: 'Pickup Trucking',
                        name_ko: '픽업 내륙운송',
                        rate: truckingRate,
                        currency: 'KRW'
                    });
                }
            }
            
            // Render additional items
            if (items.length > 0) {
                additionalSection.style.display = 'block';
                additionalItems.innerHTML = '';
                items.forEach(item => {
                    additionalItems.innerHTML += `
                        <div class="quick-quote-item">
                            <span class="quick-quote-item-name" title="${item.name_ko || ''}">${item.code}</span>
                            <span class="quick-quote-item-rate">${formatCurrency(item.rate, item.currency)}</span>
                        </div>
                    `;
                });
                
                // Update subtotal
                const totalAdditional = additionalCosts.exportCC + additionalCosts.pickup;
                document.getElementById('quick-quote-additional-subtotal').textContent = formatCurrency(totalAdditional, 'KRW');
            } else {
                additionalSection.style.display = 'none';
            }
            
            // Update total
            updateQuickQuotationTotal();
        }
        
        /**
         * Trucking Rate 조회
         */
        async function fetchTruckingRate(address) {
            // POL 코드 가져오기
            const pol = document.getElementById('input-pol')?.value;
            if (!pol) return null;
            
            const polCode = pol.split(' - ')[0]?.trim();
            if (!polCode) return null;
            
            // Container Type 가져오기
            const fclTypeSelect = document.querySelector('#fcl-rows .fcl-type');
            const containerCode = fclTypeSelect?.value?.split(' ')[0];
            if (!containerCode) return null;
            
            try {
                const params = new URLSearchParams({
                    origin_port: polCode,
                    address: address,
                    container_type: containerCode
                });
                
                const response = await fetch(`${API_BASE_URL}/api/trucking/rate?${params}`);
                if (!response.ok) return null;
                
                const data = await response.json();
                return data.rate || null;
                
            } catch (error) {
                console.error('[Trucking Rate Error]', error);
                return null;
            }
        }
        
        /**
         * Quick Quotation Total 업데이트
         */
        function updateQuickQuotationTotal() {
            if (!state.quickQuotation || !state.quickQuotation.quick_quotation) return;
            
            const data = state.quickQuotation;
            const additionalTotal = additionalCosts.exportCC + additionalCosts.pickup;
            
            // Total 계산 (기존 + Additional)
            let totalParts = [];
            if (data.total_usd > 0) totalParts.push(formatCurrency(data.total_usd, 'USD'));
            
            const totalKRW = (data.total_krw || 0) + additionalTotal;
            if (totalKRW > 0) totalParts.push(formatCurrency(totalKRW, 'KRW'));
            
            if (data.total_eur > 0) totalParts.push(formatCurrency(data.total_eur, 'EUR'));
            
            document.getElementById('quick-quote-total').textContent = totalParts.join(' + ') || '$0';
        }
        
        /**
         * 통화 포맷팅
         */
        function formatCurrency(amount, currency) {
            if (amount === null || amount === undefined) return 'N/A';
            
            const num = Number(amount);
            switch (currency) {
                case 'USD':
                    return '$' + num.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                case 'KRW':
                    return '₩' + num.toLocaleString('ko-KR');
                case 'EUR':
                    return '€' + num.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
                default:
                    return num.toLocaleString() + ' ' + currency;
            }
        }
        
        /**
         * 운임 항목 렌더링 (Full Name 포함)
         */
        function renderFreightItem(item) {
            const hasRate = item.rate !== null && item.rate !== undefined;
            return `
                <div class="quick-quote-item">
                    <div class="quick-quote-item-info">
                        <span class="quick-quote-item-code">${item.code}</span>
                        <span class="quick-quote-item-name">${item.name || ''}</span>
                        ${item.name_ko ? `<span class="quick-quote-item-name-ko">${item.name_ko}</span>` : ''}
                    </div>
                    <span class="quick-quote-item-rate ${!hasRate ? 'na' : ''}">
                        ${hasRate ? formatCurrency(item.rate, item.currency) : 'N/A'}
                    </span>
                </div>
            `;
        }
        
        // Debounce 함수 for Quick Quotation
        let quickQuotationTimeout = null;
        function triggerQuickQuotation() {
            if (quickQuotationTimeout) clearTimeout(quickQuotationTimeout);
            quickQuotationTimeout = setTimeout(fetchQuickQuotation, 500);
        }

        // ==========================================
        // CONTAINER TYPE FUNCTIONS
        // ==========================================
        
        /**
         * Fetch container types from API
         */
        async function fetchContainerTypes() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/container-types`);
                if (!response.ok) throw new Error('Failed to fetch container types');
                
                const data = await response.json();
                state.containerTypes = data;
                populateContainerTypeDropdowns();
                console.log(`[OK] Loaded ${data.length} container types`);
            } catch (error) {
                console.error('[ERROR] Failed to fetch container types:', error);
                // Fallback to default options if API fails
                state.containerTypes = [
                    { code: '20DC', name: '20 Dry Container' },
                    { code: '40DC', name: '40 Dry Container' },
                    { code: '4HDC', name: '40 HC Dry Container' }
                ];
                populateContainerTypeDropdowns();
            }
        }
        
        /**
         * Populate all container type dropdowns with fetched data
         */
        function populateContainerTypeDropdowns() {
            const dropdowns = document.querySelectorAll('.fcl-type');
            dropdowns.forEach(dropdown => {
                const currentValue = dropdown.value;
                dropdown.innerHTML = '';
                
                state.containerTypes.forEach(ct => {
                    const option = document.createElement('option');
                    option.value = ct.name;
                    option.textContent = ct.name;
                    option.dataset.code = ct.code;
                    option.dataset.maxWeight = ct.max_weight_kg || 0;
                    dropdown.appendChild(option);
                });
                
                // Restore previous selection if exists
                if (currentValue) {
                    const matchingOption = Array.from(dropdown.options).find(opt => opt.value === currentValue);
                    if (matchingOption) {
                        dropdown.value = currentValue;
                    }
                }
                
                // Add change event for Quick Quotation
                dropdown.addEventListener('change', () => {
                    updateSummary();
                    triggerQuickQuotation();
                });
            });
        }

        // ==========================================
        // FCL WEIGHT VALIDATION FUNCTIONS
        // ==========================================
        
        /**
         * Validate FCL weight against container max payload
         */
        function validateFclWeight(row) {
            const select = row.querySelector('.fcl-type');
            const weightInput = row.querySelector('.fcl-weight');
            
            if (!select || !weightInput) return true;
            
            const selectedOption = select.options[select.selectedIndex];
            const containerCode = selectedOption?.dataset?.code;
            const maxPayload = parseInt(selectedOption?.dataset?.maxWeight) || 0;
            const inputWeight = parseFloat(weightInput.value.replace(/,/g, '')) || 0;
            
            // Show/hide warning based on weight comparison
            if (maxPayload > 0 && inputWeight > maxPayload) {
                showWeightWarning(row, containerCode, maxPayload, inputWeight);
                weightInput.classList.add('exceeded');
                return false;
            } else {
                hideWeightWarning(row);
                weightInput.classList.remove('exceeded');
                return true;
            }
        }
        
        /**
         * Show weight exceeded warning tooltip
         */
        function showWeightWarning(row, containerCode, maxPayload, inputWeight) {
            // Remove existing warning if any
            hideWeightWarning(row);
            
            const weightInputGroup = row.querySelector('.fcl-weight')?.closest('.input-group');
            if (!weightInputGroup) return;
            
            const warningDiv = document.createElement('div');
            warningDiv.className = 'weight-warning';
            warningDiv.innerHTML = `
                <div class="weight-warning-line">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Max payload exceeded!</span>
                </div>
                <div class="weight-warning-line">
                    <span>${containerCode} limit: ${maxPayload.toLocaleString()} KG</span>
                </div>
            `;
            
            weightInputGroup.appendChild(warningDiv);
        }
        
        /**
         * Hide weight exceeded warning tooltip
         */
        function hideWeightWarning(row) {
            const existingWarning = row.querySelector('.weight-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
        }
        
        /**
         * Validate all FCL rows and return list of exceeded rows
         */
        function validateAllFclWeights() {
            const exceededRows = [];
            const fclRows = document.querySelectorAll('#fcl-rows .cargo-row');
            
            fclRows.forEach((row, idx) => {
                const select = row.querySelector('.fcl-type');
                const weightInput = row.querySelector('.fcl-weight');
                
                if (!select || !weightInput) return;
                
                const selectedOption = select.options[select.selectedIndex];
                const containerCode = selectedOption?.dataset?.code;
                const containerName = selectedOption?.value;
                const maxPayload = parseInt(selectedOption?.dataset?.maxWeight) || 0;
                const inputWeight = parseFloat(weightInput.value.replace(/,/g, '')) || 0;
                
                if (maxPayload > 0 && inputWeight > maxPayload) {
                    exceededRows.push({
                        rowIndex: idx + 1,
                        containerCode,
                        containerName,
                        maxPayload,
                        inputWeight
                    });
                }
            });
            
            return exceededRows;
        }
        
        /**
         * Show confirmation modal for weight exceeded
         */
        function showWeightExceededModal(exceededRows) {
            return new Promise((resolve) => {
                // Create modal overlay
                const overlay = document.createElement('div');
                overlay.className = 'weight-exceeded-modal-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                // Build exceeded items list
                const itemsList = exceededRows.map(item => `
                    <li>
                        <strong>Row ${item.rowIndex}:</strong> ${item.containerCode} 
                        (${item.inputWeight.toLocaleString()} KG / Max: ${item.maxPayload.toLocaleString()} KG)
                    </li>
                `).join('');
                
                // Create modal content
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 450px;
                    width: 90%;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                `;
                modal.innerHTML = `
                    <div style="text-align: center; margin-bottom: 16px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f59e0b;"></i>
                    </div>
                    <h3 style="margin: 0 0 12px 0; text-align: center; color: #1f2937;">Weight Limit Exceeded</h3>
                    <p style="color: #6b7280; margin-bottom: 16px; text-align: center;">
                        The following cargo rows exceed the container's maximum payload:
                    </p>
                    <ul style="background: #fef3c7; padding: 12px 12px 12px 32px; border-radius: 8px; margin-bottom: 20px; color: #92400e; font-size: 0.9rem;">
                        ${itemsList}
                    </ul>
                    <p style="color: #6b7280; margin-bottom: 20px; text-align: center; font-size: 0.9rem;">
                        Do you want to continue anyway?
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button id="weight-modal-cancel" style="
                            padding: 10px 24px;
                            border: 1px solid #d1d5db;
                            background: white;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 0.9rem;
                            color: #374151;
                        ">Cancel</button>
                        <button id="weight-modal-continue" style="
                            padding: 10px 24px;
                            border: none;
                            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                            color: white;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 0.9rem;
                            font-weight: 500;
                        ">Continue Anyway</button>
                    </div>
                `;
                
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                // Button event handlers
                document.getElementById('weight-modal-cancel').onclick = () => {
                    overlay.remove();
                    resolve(false);
                };
                
                document.getElementById('weight-modal-continue').onclick = () => {
                    overlay.remove();
                    resolve(true);
                };
                
                // Close on overlay click
                overlay.onclick = (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(false);
                    }
                };
            });
        }

        // ==========================================
        // PORT AUTOCOMPLETE FUNCTIONS
        // ==========================================
        
        let autocompleteTimeout = null;
        let currentSelectedIndex = -1;
        
        /**
         * Initialize autocomplete for POL/POD inputs
         */
        function initPortAutocomplete() {
            const polInput = document.getElementById('input-pol');
            const podInput = document.getElementById('input-pod');
            const polDropdown = document.getElementById('dropdown-pol');
            const podDropdown = document.getElementById('dropdown-pod');
            
            // Check if elements exist before setup
            if (!polInput || !podInput || !polDropdown || !podDropdown) {
                console.warn('Port autocomplete elements not found');
                return;
            }
            
            // Setup POL autocomplete
            setupAutocomplete(polInput, polDropdown, 'pol');
            
            // Setup POD autocomplete
            setupAutocomplete(podInput, podDropdown, 'pod');
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.autocomplete-wrapper')) {
                    if (polDropdown) polDropdown.classList.remove('show');
                    if (podDropdown) podDropdown.classList.remove('show');
                }
            });
        }
        
        /**
         * Setup autocomplete for a single input
         */
        function setupAutocomplete(input, dropdown, type) {
            // Null check
            if (!input || !dropdown) return;
            
            // Input event - search as user types
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Clear previous timeout
                if (autocompleteTimeout) {
                    clearTimeout(autocompleteTimeout);
                }
                
                // Hide dropdown if query is too short
                if (query.length < 2) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                // Show loading state
                dropdown.innerHTML = '<div class="autocomplete-loading">Searching</div>';
                dropdown.classList.add('show');
                
                // Debounce API call (300ms)
                autocompleteTimeout = setTimeout(() => {
                    searchPorts(query, dropdown, input);
                }, 300);
            });
            
            // Focus event - show dropdown if there's a query
            input.addEventListener('focus', (e) => {
                const query = e.target.value.trim();
                if (query.length >= 2) {
                    searchPorts(query, dropdown, input);
                }
            });
            
            // Keyboard navigation
            input.addEventListener('keydown', (e) => {
                const items = dropdown.querySelectorAll('.autocomplete-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentSelectedIndex = Math.min(currentSelectedIndex + 1, items.length - 1);
                    updateSelectedItem(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentSelectedIndex = Math.max(currentSelectedIndex - 1, 0);
                    updateSelectedItem(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentSelectedIndex >= 0 && items[currentSelectedIndex]) {
                        items[currentSelectedIndex].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdown.classList.remove('show');
                    currentSelectedIndex = -1;
                }
            });
        }
        
        /**
         * Update selected item highlight
         */
        function updateSelectedItem(items) {
            items.forEach((item, idx) => {
                item.classList.toggle('selected', idx === currentSelectedIndex);
            });
            
            // Scroll into view
            if (items[currentSelectedIndex]) {
                items[currentSelectedIndex].scrollIntoView({ block: 'nearest' });
            }
        }
        
        /**
         * Search ports via API
         */
        async function searchPorts(query, dropdown, input) {
            try {
                // Determine port type based on shipping type
                let portType = '';
                if (state.ship === 'air') {
                    portType = 'air';
                } else if (state.ship === 'ocean') {
                    portType = 'ocean';
                }
                // For 'all' or 'truck', don't filter by type
                
                // Build API URL
                let url = `${API_BASE_URL}/api/ports?search=${encodeURIComponent(query)}&limit=20`;
                if (portType) {
                    url += `&port_type=${portType}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const ports = await response.json();
                
                // Render results
                renderPortResults(ports, dropdown, input);
                
            } catch (error) {
                console.error('Port search error:', error);
                dropdown.innerHTML = '<div class="autocomplete-no-results">Search unavailable. Please try again.</div>';
            }
        }
        
        /**
         * Render port search results
         */
        function renderPortResults(ports, dropdown, input) {
            currentSelectedIndex = -1;
            
            if (ports.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-no-results">No matching ports found</div>';
                return;
            }
            
            let html = '';
            ports.forEach((port, idx) => {
                const typeClass = port.port_type === 'air' ? 'air' : 'ocean';
                const typeLabel = port.port_type === 'air' ? 'AIR' : 'SEA';
                
                html += `
                    <div class="autocomplete-item" data-code="${port.code}" data-name="${port.name}">
                        <div>
                            <span class="port-code">${port.code}</span>
                            <span class="port-name">${port.name}</span>
                            <span class="port-type ${typeClass}">${typeLabel}</span>
                        </div>
                        <span class="port-country">${port.country} (${port.country_code})</span>
                    </div>
                `;
            });
            
            dropdown.innerHTML = html;
            
            // Add click handlers
            dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const code = item.dataset.code;
                    const name = item.dataset.name;
                    
                    // Set input value (code + name)
                    input.value = `${code} - ${name}`;
                    
                    // Hide dropdown
                    dropdown.classList.remove('show');
                    currentSelectedIndex = -1;
                    
                    // Update summary
                    updateSummary();
                    
                    // Trigger Quick Quotation
                    triggerQuickQuotation();
                });
            });
        }

        // Visibility Rules for Additional Details based on Trade Mode + Incoterms
        const VISIBILITY_RULES = {
            export: {
                EXW: { 
                    showFields: ['export-cc', 'import-cc', 'shipping-insurance', 'pickup', 'delivery', 'invoice'], 
                    helperText: "Under EXW Incoterms, all transportation and responsibilities after dispatch are borne by the importer. Please specify the requested services in detail." 
                },
                FOB: { showFields: ['export-cc', 'pickup', 'invoice'] },
                CFR: { showFields: ['export-cc', 'pickup', 'invoice'] },
                CIF: { showFields: ['export-cc', 'shipping-insurance', 'pickup', 'invoice'] },
                DAP: { showFields: ['export-cc', 'shipping-insurance', 'pickup', 'delivery', 'invoice'] },
                DDP: { showFields: ['export-cc', 'import-cc', 'shipping-insurance', 'pickup', 'delivery', 'invoice'] }
            },
            import: {
                EXW: { showFields: ['export-cc', 'import-cc', 'shipping-insurance', 'pickup', 'delivery', 'invoice'] },
                FOB: { showFields: ['import-cc', 'delivery', 'invoice'] },
                CFR: { showFields: ['import-cc', 'delivery', 'invoice'] },
                CIF: { showFields: ['import-cc', 'delivery', 'invoice'] },
                DAP: { showFields: ['import-cc', 'delivery', 'invoice'] },
                DDP: { 
                    showFields: [], 
                    helperText: "Under DDP Incoterms, all transportation and responsibilities after dispatch are borne by the exporter. Please specify the requested services in detail." 
                }
            },
            domestic: {
                EXW: { showFields: ['invoice'] },
                FOB: { showFields: ['invoice'] },
                CFR: { showFields: ['invoice'] },
                CIF: { showFields: ['invoice'] },
                DAP: { showFields: ['invoice'] },
                DDP: { showFields: ['invoice'] }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            setTrade('export'); // Init Trade Mode (Export as default)
            setShip('ocean'); // Init Load Types
            
            // Fetch container types from API
            fetchContainerTypes();
            
            // Check if coming from AI Assistant
            checkAIQuoteData();
            
            const inputs = ['input-pol', 'input-pod', 'fcl-type', 'c-company', 'c-name', 'c-email', 'c-phone'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', updateSummary);
            });
            
            // LCL Calc Listeners
            document.querySelectorAll('.lcl-calc-trigger').forEach(el => el.addEventListener('input', calculateLCL));
            
            // Air Calc Listeners
            document.querySelectorAll('.air-calc-trigger').forEach(el => el.addEventListener('input', calculateAir));
            
            // Number Format Listeners (thousand separator)
            document.querySelectorAll('.number-format').forEach(el => {
                el.addEventListener('input', function(e) {
                    formatNumberInput(this);
                    updateSummary();
                });
                el.addEventListener('blur', function(e) {
                    formatNumberInput(this);
                });
            });
            
            // FCL Weight Validation Listeners
            document.querySelectorAll('.fcl-weight').forEach(el => {
                el.addEventListener('input', function() {
                    const row = this.closest('.cargo-row');
                    if (row) validateFclWeight(row);
                });
            });
            document.querySelectorAll('.fcl-type').forEach(el => {
                el.addEventListener('change', function() {
                    const row = this.closest('.cargo-row');
                    if (row) validateFclWeight(row);
                    checkReeferContainer(); // Check for Reefer container
                });
            });
            
            // Reefer Temperature Input Listeners
            document.getElementById('temp-min')?.addEventListener('input', updateSummary);
            document.getElementById('temp-max')?.addEventListener('input', updateSummary);
            
            // Integer-only Number Format Listeners
            document.querySelectorAll('.number-format-int').forEach(el => {
                el.addEventListener('input', function(e) {
                    formatIntegerInput(this);
                    updateSummary();
                });
                el.addEventListener('blur', function(e) {
                    formatIntegerInput(this);
                });
            });
            
            // Radio Labels Styling Listener
            document.querySelectorAll('input[type=radio]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Reset styling in same group
                    document.getElementsByName(this.name).forEach(r => {
                        r.parentElement.classList.remove('checked');
                    });
                    this.parentElement.classList.add('checked');
                });
            });

            // Initialize date input auto-focus
            initDateInputAutoFocus('etd');
            initDateInputAutoFocus('eta');
            
            // Date validation listeners
            ['etd-year', 'etd-month', 'etd-day', 'eta-year', 'eta-month', 'eta-day'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener('blur', validateDates);
                    el.addEventListener('input', function() {
                        // Only validate when field is complete
                        if (this.value.length === parseInt(this.maxLength)) {
                            validateDates();
                        }
                    });
                    
                    // ETD 필드 변경 시 Quick Quotation 재조회
                    if (id.startsWith('etd-')) {
                        el.addEventListener('blur', function() {
                            triggerQuickQuotation();
                        });
                    }
                }
            });

            // Initialize Additional Details visibility based on default Trade Mode + Incoterms
            updateAdditionalDetails();
            
            // Initialize row counter
            updateRowCounter();
            
            // Initialize Port Autocomplete (wrapped in try-catch to prevent blocking other init)
            try {
                initPortAutocomplete();
            } catch (e) {
                console.error('Port autocomplete init error:', e);
            }
            
            // 로그인 정보로 Customer Information 자동 완성
            populateCustomerInfoFromAuth();
        });
        
        // ==========================================
        // CUSTOMER INFORMATION AUTO-FILL
        // ==========================================
        
        /**
         * 로그인 사용자 정보로 Customer Information 자동 완성
         */
        function populateCustomerInfoFromAuth() {
            // Auth 모듈과 로그인 상태 확인
            if (window.Auth && Auth.user) {
                const user = Auth.user;
                
                // 화주(shipper)인 경우에만 자동 완성
                if (user.user_type === 'shipper') {
                    // Company Name
                    const companyInput = document.getElementById('c-company');
                    if (companyInput && user.company) {
                        companyInput.value = user.company;
                    }
                    
                    // Name
                    const nameInput = document.getElementById('c-name');
                    if (nameInput && user.name) {
                        nameInput.value = user.name;
                    }
                    
                    // Email
                    const emailInput = document.getElementById('c-email');
                    if (emailInput && user.email) {
                        emailInput.value = user.email;
                    }
                    
                    // Phone
                    const phoneInput = document.getElementById('c-phone');
                    if (phoneInput && user.phone) {
                        phoneInput.value = user.phone;
                    }
                    
                    // Summary 업데이트
                    updateSummary();
                    
                    console.log('✅ Customer Information auto-filled from login data');
                }
            }
        }

        // Number formatting function (add thousand separators)
        function formatNumberInput(input) {
            let value = input.value;
            
            // Remove existing commas and non-numeric characters except decimal point
            let cleanValue = value.replace(/,/g, '').replace(/[^0-9.]/g, '');
            
            // Handle decimal numbers
            let parts = cleanValue.split('.');
            let integerPart = parts[0] || '';
            let decimalPart = parts.length > 1 ? '.' + parts[1] : '';
            
            // Add thousand separators to integer part
            if (integerPart.length >= 4) {
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            
            input.value = integerPart + decimalPart;
        }

        // Integer-only formatting function (no decimals)
        function formatIntegerInput(input) {
            let value = input.value;
            
            // Remove existing commas and non-numeric characters (including decimal point)
            let cleanValue = value.replace(/,/g, '').replace(/[^0-9]/g, '');
            
            // Add thousand separators
            if (cleanValue.length >= 4) {
                cleanValue = cleanValue.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            
            input.value = cleanValue;
        }

        // Get raw number value (without commas)
        function getRawNumber(inputId) {
            const el = document.getElementById(inputId);
            if (!el) return 0;
            const value = el.value.replace(/,/g, '');
            return parseFloat(value) || 0;
        }

        // ==========================================
        // DATE VALIDATION FUNCTIONS
        // ==========================================
        
        /**
         * Get date from individual input fields
         */
        function getDateFromInputs(prefix) {
            const year = document.getElementById(`${prefix}-year`)?.value;
            const month = document.getElementById(`${prefix}-month`)?.value;
            const day = document.getElementById(`${prefix}-day`)?.value;
            
            if (!year || !month || !day || year.length !== 4) return null;
            
            return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        }
        
        /**
         * Get today's date at midnight
         */
        function getTodayDate() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return today;
        }
        
        /**
         * Show date error message
         */
        function showDateError(prefix, message) {
            const errorDiv = document.getElementById(`${prefix}-error`);
            const inputGroup = document.getElementById(`${prefix}-input-group`);
            
            if (errorDiv) {
                errorDiv.querySelector('span').textContent = message;
                errorDiv.style.display = 'flex';
            }
            if (inputGroup) {
                inputGroup.classList.add('error');
            }
        }
        
        /**
         * Hide date error message
         */
        function hideDateError(prefix) {
            const errorDiv = document.getElementById(`${prefix}-error`);
            const inputGroup = document.getElementById(`${prefix}-input-group`);
            
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
            if (inputGroup) {
                inputGroup.classList.remove('error');
            }
        }
        
        /**
         * Validate ETD and ETA dates
         * Returns true if valid, false if invalid
         */
        function validateDates() {
            // Skip validation for domestic mode
            if (state.trade === 'domestic') {
                hideDateError('etd');
                hideDateError('eta');
                return true;
            }
            
            const today = getTodayDate();
            const etdDate = getDateFromInputs('etd');
            const etaDate = getDateFromInputs('eta');
            
            let isValid = true;
            
            // Validate ETD
            if (etdDate) {
                // ETD cannot be in the past
                if (etdDate < today) {
                    showDateError('etd', 'ETD cannot be in the past.');
                    isValid = false;
                }
                // For Ocean/Air, ETD cannot be today
                else if (etdDate.getTime() === today.getTime() && (state.ship === 'ocean' || state.ship === 'air')) {
                    showDateError('etd', 'Please check ETD.');
                    isValid = false;
                } else {
                    hideDateError('etd');
                }
            } else {
                hideDateError('etd');
            }
            
            // Validate ETA
            if (etaDate) {
                // ETA cannot be in the past
                if (etaDate < today) {
                    showDateError('eta', 'ETA cannot be in the past.');
                    isValid = false;
                }
                // ETA cannot be earlier than ETD
                else if (etdDate && etaDate < etdDate) {
                    showDateError('eta', 'ETA cannot be earlier than ETD.');
                    isValid = false;
                } else {
                    hideDateError('eta');
                }
            } else {
                hideDateError('eta');
            }
            
            return isValid;
        }

        // Date Input Auto-Focus Function
        function initDateInputAutoFocus(prefix) {
            const yearInput = document.getElementById(`${prefix}-year`);
            const monthInput = document.getElementById(`${prefix}-month`);
            const dayInput = document.getElementById(`${prefix}-day`);
            const hourInput = document.getElementById(`${prefix}-hour`);
            const minuteInput = document.getElementById(`${prefix}-minute`);
            const hiddenInput = document.getElementById(`input-${prefix}`);

            if (!yearInput || !monthInput || !dayInput || !hiddenInput) return;

            // Helper: Update hidden input with combined date/time
            function updateHiddenDate() {
                const year = yearInput.value.padStart(4, '0');
                const month = monthInput.value.padStart(2, '0');
                const day = dayInput.value.padStart(2, '0');
                const hour = hourInput ? hourInput.value.padStart(2, '0') : '';
                const minute = minuteInput ? minuteInput.value.padStart(2, '0') : '';
                
                if (year && month && day && year.length === 4 && month.length === 2 && day.length === 2) {
                    if (state.trade === 'domestic' && hour && minute) {
                        hiddenInput.value = `${year}-${month}-${day} ${hour}:${minute}`;
                    } else {
                        hiddenInput.value = `${year}-${month}-${day}`;
                    }
                } else {
                    hiddenInput.value = '';
                }
                updateSummary();
            }

            // Helper: Allow only numeric input
            function filterNumeric(e) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            }

            // Year input: auto-focus to month when 4 digits entered
            yearInput.addEventListener('input', function(e) {
                filterNumeric(e);
                if (this.value.length === 4) {
                    monthInput.focus();
                    monthInput.select();
                }
                updateHiddenDate();
            });

            // Month input: auto-focus to day when 2 digits entered
            monthInput.addEventListener('input', function(e) {
                filterNumeric(e);
                // Validate month range (01-12)
                if (this.value.length === 2) {
                    let val = parseInt(this.value, 10);
                    if (val > 12) this.value = '12';
                    if (val < 1 && this.value !== '0' && this.value !== '00') this.value = '01';
                    dayInput.focus();
                    dayInput.select();
                }
                updateHiddenDate();
            });

            // Day input: validate and auto-focus to hour when in Domestic mode
            dayInput.addEventListener('input', function(e) {
                filterNumeric(e);
                // Validate day range (01-31)
                if (this.value.length === 2) {
                    let val = parseInt(this.value, 10);
                    if (val > 31) this.value = '31';
                    if (val < 1 && this.value !== '0' && this.value !== '00') this.value = '01';
                    // Auto-focus to hour input if in Domestic mode
                    if (state.trade === 'domestic' && hourInput) {
                        hourInput.focus();
                        hourInput.select();
                    }
                }
                updateHiddenDate();
            });

            // Hour input: validate and auto-focus to minute
            if (hourInput) {
                hourInput.addEventListener('input', function(e) {
                    filterNumeric(e);
                    // Validate hour range (00-23)
                    if (this.value.length === 2) {
                        let val = parseInt(this.value, 10);
                        if (val > 23) this.value = '23';
                        if (minuteInput) {
                            minuteInput.focus();
                            minuteInput.select();
                        }
                    }
                    updateHiddenDate();
                });
            }

            // Minute input: validate
            if (minuteInput) {
                minuteInput.addEventListener('input', function(e) {
                    filterNumeric(e);
                    // Validate minute range (00-59)
                    if (this.value.length === 2) {
                        let val = parseInt(this.value, 10);
                        if (val > 59) this.value = '59';
                    }
                    updateHiddenDate();
                });
            }

            // Handle backspace to go back to previous field
            monthInput.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value === '' && this.selectionStart === 0) {
                    yearInput.focus();
                    yearInput.setSelectionRange(yearInput.value.length, yearInput.value.length);
                }
            });

            dayInput.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && this.value === '' && this.selectionStart === 0) {
                    monthInput.focus();
                    monthInput.setSelectionRange(monthInput.value.length, monthInput.value.length);
                }
            });

            if (hourInput) {
                hourInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value === '' && this.selectionStart === 0) {
                        dayInput.focus();
                        dayInput.setSelectionRange(dayInput.value.length, dayInput.value.length);
                    }
                });
            }

            if (minuteInput) {
                minuteInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value === '' && this.selectionStart === 0) {
                        hourInput.focus();
                        hourInput.setSelectionRange(hourInput.value.length, hourInput.value.length);
                    }
                });
            }

            // Focus events for select-all behavior
            [yearInput, monthInput, dayInput].forEach(input => {
                input.addEventListener('focus', function() {
                    setTimeout(() => this.select(), 0);
                });
            });
        }

        // Update Additional Details visibility based on Trade Mode + Incoterms
        function updateAdditionalDetails() {
            const tradeMode = state.trade;
            const incoterms = state.incoterms;
            
            // Get rules for current combination
            const rules = VISIBILITY_RULES[tradeMode]?.[incoterms];
            if (!rules) return;
            
            const showFields = rules.showFields || [];
            const helperText = rules.helperText || null;
            
            // All possible field IDs
            const allFields = ['export-cc', 'import-cc', 'shipping-insurance', 'pickup', 'delivery', 'invoice'];
            
            // Show/hide each field
            allFields.forEach(field => {
                const row = document.getElementById(`row-${field}`);
                if (row) {
                    // Hide shipping-insurance for Ocean Express (Bulk)
                    if (field === 'shipping-insurance' && state.load === 'Bulk') {
                        row.style.display = 'none';
                    } else {
                        row.style.display = showFields.includes(field) ? '' : 'none';
                    }
                }
            });
            
            // Handle Remark helper text and highlighting
            const remarkSection = document.getElementById('remark-section');
            const remarkHelper = document.getElementById('remark-helper');
            
            const remarkRequired = document.getElementById('remark-required');
            if (helperText && remarkSection && remarkHelper) {
                remarkHelper.textContent = helperText;
                remarkHelper.style.display = 'block';
                remarkSection.classList.add('highlighted');
                if (remarkRequired) remarkRequired.style.display = 'inline';
            } else if (remarkSection && remarkHelper) {
                remarkHelper.textContent = '';
                remarkHelper.style.display = 'none';
                remarkSection.classList.remove('highlighted');
                if (remarkRequired) remarkRequired.style.display = 'none';
            }
            
            updateSummary();
        }

        // Functions
        
        // 상세 견적 버튼 표시 (Estimated Freight 출력 후)
        function showDetailedQuoteButton() {
            const btnSection = document.getElementById('detailed-quote-btn-section');
            if (btnSection) {
                btnSection.style.display = 'block';
            }
        }
        
        // 상세 견적 버튼 숨김 및 Phase 2 섹션 초기화
        function hideDetailedQuoteButton() {
            const btnSection = document.getElementById('detailed-quote-btn-section');
            const detailedSection = document.getElementById('detailed-quote-section');
            
            if (btnSection) {
                btnSection.style.display = 'none';
            }
            if (detailedSection) {
                detailedSection.style.display = 'none';
            }
            
            // 버튼 상태 초기화
            resetDetailedQuoteButton();
        }
        
        // 버튼 상태 초기화
        function resetDetailedQuoteButton() {
            const icon = document.getElementById('btn-detailed-icon');
            const text = document.getElementById('btn-detailed-text');
            
            if (icon) icon.className = 'fas fa-plus-circle';
            if (text) text.textContent = '상세 견적 요청';
        }
        
        // Toggle Quote Breakdown (상세 보기) - 펼치기/접기
        function toggleQuoteBreakdown() {
            const breakdown = document.getElementById('quick-quote-breakdown');
            const btn = document.getElementById('btn-breakdown-toggle');
            const icon = document.getElementById('breakdown-toggle-icon');
            const text = document.getElementById('breakdown-toggle-text');
            
            if (breakdown.style.display === 'none') {
                breakdown.style.display = 'grid';
                btn.classList.add('expanded');
                text.textContent = '상세 접기';
            } else {
                breakdown.style.display = 'none';
                btn.classList.remove('expanded');
                text.textContent = '상세 보기';
            }
        }
        
        // Toggle Detailed Quote Section (Phase 2) - 펼치기/접기
        function toggleDetailedQuoteSection() {
            const detailedSection = document.getElementById('detailed-quote-section');
            const icon = document.getElementById('btn-detailed-icon');
            const text = document.getElementById('btn-detailed-text');
            
            if (!detailedSection) return;
            
            const isHidden = detailedSection.style.display === 'none' || detailedSection.style.display === '';
            
            if (isHidden) {
                // 펼치기
                detailedSection.style.display = 'block';
                if (icon) icon.className = 'fas fa-minus-circle';
                if (text) text.textContent = '상세 견적 접기';
                
                // Scroll to the section
                detailedSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                // 접기
                detailedSection.style.display = 'none';
                if (icon) icon.className = 'fas fa-plus-circle';
                if (text) text.textContent = '상세 견적 요청';
            }
        }
        
        // Hide Detailed Quote Section (Phase 2) - for reset (하위 호환성)
        function hideDetailedQuoteSection() {
            const detailedSection = document.getElementById('detailed-quote-section');
            
            if (detailedSection) {
                detailedSection.style.display = 'none';
            }
            resetDetailedQuoteButton();
        }

        function setTrade(val) {
            state.trade = val;
            document.getElementById('trade-export').classList.toggle('active', val === 'export');
            document.getElementById('trade-import').classList.toggle('active', val === 'import');
            document.getElementById('trade-domestic').classList.toggle('active', val === 'domestic');
            
            // Update icon box styles
            document.querySelector('#trade-export .icon-box').style.background = val === 'export' ? 'var(--accent-color)' : '#555';
            document.querySelector('#trade-import .icon-box').style.background = val === 'import' ? 'var(--accent-color)' : '#555';
            document.querySelector('#trade-domestic .icon-box').style.background = val === 'domestic' ? 'var(--accent-color)' : '#555';
            
            // Handle Domestic mode - Show only Trucking option and auto-select
            const shipAll = document.getElementById('ship-all');
            const shipOcean = document.getElementById('ship-ocean');
            const shipAir = document.getElementById('ship-air');
            const shipTruck = document.getElementById('ship-truck');
            const schedulesHeader = document.getElementById('schedules-header');
            
            // Time fields for Domestic mode
            const etdTimeFields = document.getElementById('etd-time-fields');
            const etaTimeFields = document.getElementById('eta-time-fields');
            
            // Incoterms section for Domestic mode
            const incotermsSection = document.getElementById('incoterms-section');
            
            if (val === 'domestic') {
                // Hide All, Ocean, Air options - show only Trucking
                shipAll.style.display = 'none';
                shipOcean.style.display = 'none';
                shipAir.style.display = 'none';
                shipTruck.style.display = 'flex';
                // Force Trucking mode
                setShip('truck');
                // Change header to Trucking Schedules
                schedulesHeader.innerHTML = 'Trucking Schedules <i class="far fa-question-circle info-icon"></i>';
                // Show time input fields for Domestic
                if (etdTimeFields) etdTimeFields.style.display = 'contents';
                if (etaTimeFields) etaTimeFields.style.display = 'contents';
                // Hide Incoterms section for Domestic
                if (incotermsSection) incotermsSection.style.display = 'none';
            } else {
                // Show shipping type options except Trucking for Export/Import
                shipAll.style.display = 'flex';
                shipOcean.style.display = 'flex';
                shipAir.style.display = 'flex';
                shipTruck.style.display = 'none'; // Hide Trucking for Export/Import
                // Hide time input fields
                if (etdTimeFields) etdTimeFields.style.display = 'none';
                // Show Incoterms section
                if (incotermsSection) incotermsSection.style.display = 'block';
                // If currently on Trucking, switch to Ocean
                if (state.ship === 'truck') {
                    setShip('ocean');
                }
                if (etaTimeFields) etaTimeFields.style.display = 'none';
                // Restore header to Shipping Schedules
                schedulesHeader.innerHTML = 'Shipping Schedules <i class="far fa-question-circle info-icon"></i>';
            }
            
            updateAdditionalDetails();
            validateDates(); // Re-validate dates when trade mode changes
        }

        function setShip(val) {
            state.ship = val;
            // UI Toggle
            ['all', 'ocean', 'air', 'truck'].forEach(t => {
                const el = document.getElementById(`ship-${t}`);
                if(el) el.classList.toggle('active', t === val);
            });

            // Update Labels
            const labels = {
                all: ["Port of Loading / Airport", "Port of Discharging / Airport", "CBM"],
                air: ["Departure Airport (POL)", "Arrival Airport (POD)", "Chargeable Weight"],
                ocean: ["Port of Loading (POL)", "Port of Discharging (POD)", "R.TON"],
                truck: ["Pickup Address", "Delivery Address", "Weight/CBM"]
            };
            const current = labels[val] || labels.ocean;
            document.getElementById('label-pol').innerHTML = current[0] + ' <span class="text-red">*</span>';
            document.getElementById('label-pod').innerHTML = current[1] + ' <span class="text-red">*</span>';
            if(document.getElementById('label-rton')) document.getElementById('label-rton').innerText = current[2];

            // Clear POL/POD values when shipping type changes
            document.getElementById('input-pol').value = '';
            document.getElementById('input-pod').value = '';

            // Hide/Show Load Type section based on shipping type
            const loadTypeSection = document.getElementById('load-type-section');
            const allNotice = document.getElementById('all-notice');
            
            if (val === 'all') {
                // All: Hide Load Type, show LCL cargo view, show notice
                if (loadTypeSection) loadTypeSection.style.display = 'none';
                state.load = 'All';
                toggleCargoInput('LCL'); // Use LCL view for All
                if (allNotice) allNotice.style.display = 'block';
            } else if (val === 'air') {
                // Air: Hide Load Type, show Air cargo view directly
                if (loadTypeSection) loadTypeSection.style.display = 'none';
                state.load = 'Air';
                toggleCargoInput('Air');
                if (allNotice) allNotice.style.display = 'none';
            } else {
                // Ocean/Truck: Show Load Type section
                if (loadTypeSection) loadTypeSection.style.display = 'block';
                renderLoadTypes(val);
                if (allNotice) allNotice.style.display = 'none';
            }
            
            updateSummary();
            checkReeferContainer(); // Check for Reefer container on ship type change
            validateDates(); // Re-validate dates when ship mode changes (Ocean/Air have different rules)
            
            // Quick Quotation - Ocean + FCL만 지원
            if (val === 'ocean') {
                triggerQuickQuotation();
            } else {
                hideQuickQuotation();
            }
        }

        function renderLoadTypes(type) {
            const container = document.getElementById('load-type-container');
            container.innerHTML = '';
            
            let opts = [];
            if (type === 'ocean') opts = [
                {code: 'FCL', label: 'FCL', sub: '(Full Container Load)', icon: 'fa-container-storage'}, 
                {code: 'LCL', label: 'LCL', sub: '(Less-than-Container)', icon: 'fa-boxes'}, 
                {code: 'Bulk', label: 'BULK', sub: '(Bulk Cargo)', icon: 'fa-cubes'}
            ];
            else if (type === 'air') opts = [
                {code: 'Express', label: 'Express', sub: '(Courier)', icon: 'fa-plane-departure'},
                {code: 'Consol', label: 'Consol', sub: '(Standard Air)', icon: 'fa-box-open'}
            ];
            else opts = [
                {code: 'FTL', label: 'FTL', sub: '(Full Truck)', icon: 'fa-truck-moving'},
                {code: 'LTL', label: 'LTL', sub: '(Less Truck)', icon: 'fa-dolly'}
            ];

            opts.forEach((opt, idx) => {
                const isActive = idx === 0;
                if(isActive) state.load = opt.code;
                
                const div = document.createElement('div');
                div.className = `option-card ${isActive ? 'active' : ''}`;
                div.innerHTML = `
                    <i class="fas ${opt.icon}"></i>
                    <div style="text-align:center; line-height:1.2;">${opt.label}<br>
                    <span style="font-size:0.8rem; font-weight:400; opacity:0.8">${opt.sub}</span></div>
                `;
                div.onclick = () => {
                    container.querySelectorAll('.option-card').forEach(c => c.classList.remove('active'));
                    div.classList.add('active');
                    state.load = opt.code;
                    toggleCargoInput(opt.code);
                    updateAdditionalDetails();
                    updateSummary();
                    checkReeferContainer(); // Check for Reefer container on load type change
                    
                    // Quick Quotation - FCL만 지원
                    if (opt.code === 'FCL') {
                        triggerQuickQuotation();
                    } else {
                        hideQuickQuotation();
                    }
                };
                container.appendChild(div);
            });
            toggleCargoInput(state.load);
            updateSummary();
        }

        function toggleCargoInput(loadCode) {
            const isFcl = loadCode === 'FCL';
            const isFtl = loadCode === 'FTL';
            const isAir = loadCode === 'Air';
            const isLcl = !isFcl && !isFtl && !isAir;
            
            document.getElementById('fcl-view').style.display = isFcl ? 'block' : 'none';
            document.getElementById('ftl-view').style.display = isFtl ? 'block' : 'none';
            document.getElementById('lcl-view').style.display = isLcl ? 'block' : 'none';
            document.getElementById('air-view').style.display = isAir ? 'block' : 'none';
            
            // Show DG checkbox wrapper for all load types (same position as LTL)
            const dgCheckboxWrapper = document.getElementById('dg-checkbox-wrapper');
            if (dgCheckboxWrapper) {
                dgCheckboxWrapper.style.display = 'flex';
            }
            
            // Update row counter for current load type
            updateRowCounter();
        }

        function setInco(el, code) {
            document.getElementById('incoterm-container').querySelectorAll('.incoterm-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            state.incoterms = code;
            updateAdditionalDetails();
        }

        // Cargo Row Management
        const MAX_CARGO_ROWS = 10;
        
        function getCargoRowsContainer() {
            if (state.load === 'FCL') return document.getElementById('fcl-rows');
            if (state.load === 'FTL') return document.getElementById('ftl-rows');
            if (state.load === 'Air') return document.getElementById('air-rows');
            return document.getElementById('lcl-rows'); // LCL, LTL, Bulk, All
        }
        
        function getCargoRowCount() {
            const container = getCargoRowsContainer();
            return container ? container.querySelectorAll('.cargo-row').length : 0;
        }
        
        function updateRowCounter() {
            const count = getCargoRowCount();
            document.getElementById('row-counter').textContent = `${count} / ${MAX_CARGO_ROWS}`;
            document.getElementById('btn-add-cargo').disabled = count >= MAX_CARGO_ROWS;
            
            // Update delete button states
            const container = getCargoRowsContainer();
            if (container) {
                const rows = container.querySelectorAll('.cargo-row');
                rows.forEach((row, idx) => {
                    const deleteBtn = row.querySelector('.row-delete');
                    if (deleteBtn) {
                        if (rows.length === 1) {
                            deleteBtn.classList.add('disabled');
                        } else {
                            deleteBtn.classList.remove('disabled');
                        }
                    }
                });
            }
        }
        
        function addCargoRow() {
            const count = getCargoRowCount();
            if (count >= MAX_CARGO_ROWS) return;
            
            const container = getCargoRowsContainer();
            if (!container) return;
            
            const firstRow = container.querySelector('.cargo-row');
            const newRow = firstRow.cloneNode(true);
            newRow.setAttribute('data-row-index', count);
            
            // Clear values in new row
            newRow.querySelectorAll('input[type="text"]').forEach(input => {
                if (input.classList.contains('lcl-qty') || input.classList.contains('air-qty') || input.classList.contains('fcl-qty') || input.classList.contains('ftl-qty')) {
                    input.value = '1';
                } else if (input.hasAttribute('readonly')) {
                    input.value = '0';
                    if (input.classList.contains('lcl-cbm')) input.value = '0.0';
                } else {
                    input.value = '';
                }
            });
            
            newRow.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Enable delete button on new row
            const deleteBtn = newRow.querySelector('.row-delete');
            if (deleteBtn) {
                deleteBtn.classList.remove('disabled');
            }
            
            // Add event listeners for new row
            newRow.querySelectorAll('.lcl-calc-trigger').forEach(el => {
                el.addEventListener('input', () => calculateAllLCL());
            });
            newRow.querySelectorAll('.air-calc-trigger').forEach(el => {
                el.addEventListener('input', () => calculateAllAir());
            });
            newRow.querySelectorAll('.number-format').forEach(el => {
                el.addEventListener('input', function() { formatNumberInput(this); updateSummary(); });
                el.addEventListener('blur', function() { formatNumberInput(this); });
            });
            newRow.querySelectorAll('.number-format-int').forEach(el => {
                el.addEventListener('input', function() { formatIntegerInput(this); updateSummary(); });
                el.addEventListener('blur', function() { formatIntegerInput(this); });
            });
            
            // FCL Weight Validation Listeners for new row
            newRow.querySelectorAll('.fcl-weight').forEach(el => {
                el.addEventListener('input', function() {
                    const row = this.closest('.cargo-row');
                    if (row) validateFclWeight(row);
                });
            });
            newRow.querySelectorAll('.fcl-type').forEach(el => {
                el.addEventListener('change', function() {
                    const row = this.closest('.cargo-row');
                    if (row) validateFclWeight(row);
                    checkReeferContainer(); // Check for Reefer container
                });
            });
            
            container.appendChild(newRow);
            updateRowCounter();
            updateSummary();
        }
        
        function deleteCargoRow(btn) {
            const row = btn.closest('.cargo-row');
            const container = getCargoRowsContainer();
            
            if (!container || container.querySelectorAll('.cargo-row').length <= 1) return;
            
            row.remove();
            
            // Re-index rows
            container.querySelectorAll('.cargo-row').forEach((r, idx) => {
                r.setAttribute('data-row-index', idx);
            });
            
            updateRowCounter();
            calculateAllLCL();
            calculateAllAir();
            updateSummary();
            checkReeferContainer(); // Re-check for Reefer container
        }

        function toggleDG(checked) {
            document.getElementById('dg-inputs').style.display = checked ? 'grid' : 'none';
        }

        // Reefer Temperature Functions
        let tempUnit = 'C'; // Default to Celsius
        
        function setTempUnit(unit) {
            tempUnit = unit;
            document.querySelectorAll('.temp-unit-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.unit === unit);
            });
            updateSummary(); // Update summary when unit changes
        }
        
        function checkReeferContainer() {
            const reeferSection = document.getElementById('reefer-temp-section');
            if (!reeferSection) return;
            
            // Check if any FCL row has a Reefer container selected
            let hasReefer = false;
            
            if (state.load === 'FCL') {
                const fclRows = document.querySelectorAll('#fcl-rows .cargo-row');
                fclRows.forEach(row => {
                    const select = row.querySelector('.fcl-type');
                    if (select) {
                        const selectedOption = select.options[select.selectedIndex];
                        const code = selectedOption?.dataset?.code || '';
                        // Check if it's a Reefer container (RF category)
                        if (code.includes('RF') || code === '20RF' || code === '4HRF') {
                            hasReefer = true;
                        }
                    }
                });
            }
            
            // Show/hide reefer section
            if (hasReefer) {
                reeferSection.classList.add('show');
            } else {
                reeferSection.classList.remove('show');
                // Clear inputs when hidden
                document.getElementById('temp-min').value = '';
                document.getElementById('temp-max').value = '';
            }
        }
        

        function toggleAddr(id, show) {
            document.getElementById(id + '-group').style.display = show ? 'flex' : 'none';
            updateSummary();
        }

        function calculateLCL() {
            calculateAllLCL();
        }
        
        function calculateAllLCL() {
            const container = document.getElementById('lcl-rows');
            if (!container) return;
            
            container.querySelectorAll('.cargo-row').forEach(row => {
                const l = parseFloat(row.querySelector('.lcl-l')?.value.replace(/,/g, '') || 0);
                const w = parseFloat(row.querySelector('.lcl-w')?.value.replace(/,/g, '') || 0);
                const h = parseFloat(row.querySelector('.lcl-h')?.value.replace(/,/g, '') || 0);
                
                // CBM calculation: L x W x H / 1000000, rounded to 1 decimal place
                const cbm = Math.round((l * w * h / 1000000) * 10) / 10;
                
                const cbmInput = row.querySelector('.lcl-cbm');
                if (cbmInput) cbmInput.value = cbm.toFixed(1);
            });
            updateSummary();
        }

        function calculateAir() {
            calculateAllAir();
        }
        
        function calculateAllAir() {
            const container = document.getElementById('air-rows');
            if (!container) return;
            
            container.querySelectorAll('.cargo-row').forEach(row => {
                const l = parseFloat(row.querySelector('.air-l')?.value.replace(/,/g, '') || 0);
                const w = parseFloat(row.querySelector('.air-w')?.value.replace(/,/g, '') || 0);
                const h = parseFloat(row.querySelector('.air-h')?.value.replace(/,/g, '') || 0);
                const grossWeightPerPkg = Math.round(parseFloat(row.querySelector('.air-gross-weight')?.value.replace(/,/g, '') || 0));
                
                // Volume Weight (per pkg) = L x W x H / 6000, rounded to integer
                const volumeWeightPerPkg = Math.round(l * w * h / 6000);
                
                // Chargeable Weight (per pkg) = max(Gross Weight per pkg, Volume Weight per pkg)
                const chargeableWeightPerPkg = Math.max(grossWeightPerPkg, volumeWeightPerPkg);
                
                const vwInput = row.querySelector('.air-volume-weight');
                const cwInput = row.querySelector('.air-chargeable-weight');
                if (vwInput) vwInput.value = volumeWeightPerPkg.toLocaleString('en-US');
                if (cwInput) cwInput.value = chargeableWeightPerPkg.toLocaleString('en-US');
            });
            updateSummary();
        }

        function updateSummary() {
            // Header
            document.getElementById('s-trade').innerText = state.trade.toUpperCase();
            document.getElementById('s-ship').innerText = state.ship.toUpperCase();
            
            // Handle Load Type for All shipping type
            const sLoadEl = document.getElementById('s-load');
            const sLoadLi = sLoadEl.parentElement;
            if (state.ship === 'all') {
                sLoadLi.style.display = 'none';
            } else {
                sLoadLi.style.display = '';
                sLoadEl.innerText = state.load;
            }
            
            document.getElementById('s-inco').innerText = state.incoterms;
            
            // Update Schedules label based on trade mode
            const scheduleLabel = document.getElementById('s-schedule-label');
            if (scheduleLabel) {
                scheduleLabel.innerText = state.trade === 'domestic' ? 'Trucking Schedules' : 'Shipping Schedules';
            }

            // Route & Date
            const pol = document.getElementById('input-pol').value || '-';
            const pod = document.getElementById('input-pod').value || '-';
            
            // Format ETD from individual fields
            const etdYear = document.getElementById('etd-year').value;
            const etdMonth = document.getElementById('etd-month').value;
            const etdDay = document.getElementById('etd-day').value;
            const etdHour = document.getElementById('etd-hour')?.value || '';
            const etdMinute = document.getElementById('etd-minute')?.value || '';
            let etd = '-';
            if (etdYear && etdMonth && etdDay) {
                etd = `${etdYear}/${etdMonth.padStart(2, '0')}/${etdDay.padStart(2, '0')}`;
                if (state.trade === 'domestic' && etdHour && etdMinute) {
                    etd += ` ${etdHour.padStart(2, '0')}:${etdMinute.padStart(2, '0')}`;
                }
            }
            
            // Format ETA from individual fields
            const etaYear = document.getElementById('eta-year').value;
            const etaMonth = document.getElementById('eta-month').value;
            const etaDay = document.getElementById('eta-day').value;
            const etaHour = document.getElementById('eta-hour')?.value || '';
            const etaMinute = document.getElementById('eta-minute')?.value || '';
            let eta = '-';
            if (etaYear && etaMonth && etaDay) {
                eta = `${etaYear}/${etaMonth.padStart(2, '0')}/${etaDay.padStart(2, '0')}`;
                if (state.trade === 'domestic' && etaHour && etaMinute) {
                    eta += ` ${etaHour.padStart(2, '0')}:${etaMinute.padStart(2, '0')}`;
                }
            }
            
            document.getElementById('s-schedule').innerHTML = `${pol} → ${pod}<br><span style="color:#666; font-size:0.8em">${etd} → ${eta}</span>`;

            // Cargo - Multi-row support
            let cargoTxt = '';
            
            if (state.load === 'FCL') {
                const rows = document.querySelectorAll('#fcl-rows .cargo-row');
                const rowSummaries = [];
                let totalQty = 0;
                
                rows.forEach((row, idx) => {
                    const type = row.querySelector('.fcl-type')?.value || '';
                    const qty = parseInt(row.querySelector('.fcl-qty')?.value.replace(/,/g, '') || 0);
                    if (type && qty > 0) {
                        rowSummaries.push(`#${idx + 1}: ${type} x ${qty}`);
                        totalQty += qty;
                    }
                });
                
                if (rowSummaries.length > 0) {
                    if (rowSummaries.length === 1) {
                        cargoTxt = rowSummaries[0].replace('#1: ', '');
                    } else {
                        cargoTxt = rowSummaries.join('<br>') + `<br><span style="color:#888;">───</span><br><b>Total: ${totalQty} containers</b>`;
                    }
                    
                    // Add Reefer Temperature if active
                    const reeferSection = document.getElementById('reefer-temp-section');
                    if (reeferSection && reeferSection.classList.contains('show')) {
                        const tempMin = document.getElementById('temp-min')?.value.trim() || '';
                        const tempMax = document.getElementById('temp-max')?.value.trim() || '';
                        if (tempMin || tempMax) {
                            const unitSymbol = tempUnit === 'C' ? '°C' : '°F';
                            const tempRange = tempMin && tempMax 
                                ? `${tempMin} ~ ${tempMax}${unitSymbol}`
                                : tempMin 
                                    ? `${tempMin}${unitSymbol}`
                                    : `${tempMax}${unitSymbol}`;
                            cargoTxt += `<br><span style="color: #00bcd4;"><i class="fas fa-thermometer-half"></i> ${tempRange}</span>`;
                        }
                    }
                } else {
                    cargoTxt = '-';
                }
            } else if (state.load === 'FTL') {
                const rows = document.querySelectorAll('#ftl-rows .cargo-row');
                const rowSummaries = [];
                let totalQty = 0;
                
                rows.forEach((row, idx) => {
                    const type = row.querySelector('.ftl-type')?.value || '';
                    const qty = parseInt(row.querySelector('.ftl-qty')?.value.replace(/,/g, '') || 0);
                    if (type && qty > 0) {
                        rowSummaries.push(`#${idx + 1}: ${type} x ${qty}`);
                        totalQty += qty;
                    }
                });
                
                if (rowSummaries.length > 0) {
                    if (rowSummaries.length === 1) {
                        cargoTxt = rowSummaries[0].replace('#1: ', '');
                    } else {
                        cargoTxt = rowSummaries.join('<br>') + `<br><span style="color:#888;">───</span><br><b>Total: ${totalQty} trucks</b>`;
                    }
                } else {
                    cargoTxt = '-';
                }
            } else if (state.load === 'Air') {
                const rows = document.querySelectorAll('#air-rows .cargo-row');
                const rowSummaries = [];
                let grandTotalGW = 0, grandTotalVW = 0, grandTotalCW = 0;
                let hasCompleteRow = false;
                
                rows.forEach((row, idx) => {
                    const l = row.querySelector('.air-l')?.value || '';
                    const w = row.querySelector('.air-w')?.value || '';
                    const h = row.querySelector('.air-h')?.value || '';
                    const qty = row.querySelector('.air-qty')?.value || '';
                    const gw = row.querySelector('.air-gross-weight')?.value || '';
                    const vw = row.querySelector('.air-volume-weight')?.value || '';
                    const cw = row.querySelector('.air-chargeable-weight')?.value || '';
                    
                    const isComplete = l && l !== '0' && w && w !== '0' && h && h !== '0' && qty && qty !== '0' && gw && gw !== '0';
                    
                    if (isComplete) {
                        hasCompleteRow = true;
                        const qtyNum = parseInt(qty.replace(/,/g, ''), 10) || 0;
                        const gwNum = parseInt(gw.replace(/,/g, ''), 10) || 0;
                        const vwNum = parseInt(vw.replace(/,/g, ''), 10) || 0;
                        const cwNum = parseInt(cw.replace(/,/g, ''), 10) || 0;
                        
                        grandTotalGW += gwNum * qtyNum;
                        grandTotalVW += vwNum * qtyNum;
                        grandTotalCW += cwNum * qtyNum;
                        
                        rowSummaries.push(`#${idx + 1}: ${l}x${w}x${h}cm x ${qty}pcs`);
                    }
                });
                
                if (hasCompleteRow) {
                    if (rowSummaries.length === 1) {
                        const row = rows[0];
                        const l = row.querySelector('.air-l')?.value;
                        const w = row.querySelector('.air-w')?.value;
                        const h = row.querySelector('.air-h')?.value;
                        const qty = row.querySelector('.air-qty')?.value;
                        const gw = row.querySelector('.air-gross-weight')?.value;
                        const vw = row.querySelector('.air-volume-weight')?.value;
                        const cw = row.querySelector('.air-chargeable-weight')?.value;
                        cargoTxt = `${l}x${w}x${h}cm x ${qty}pcs<br>G.W:${gw} / V.W:${vw} / C.W:${cw} KG<br>Total G.W:${grandTotalGW.toLocaleString('en-US')} / V.W:${grandTotalVW.toLocaleString('en-US')} / C.W:${grandTotalCW.toLocaleString('en-US')} KG`;
                    } else {
                        cargoTxt = rowSummaries.join('<br>') + `<br><span style="color:#888;">───</span><br><b>Total G.W:${grandTotalGW.toLocaleString('en-US')} / V.W:${grandTotalVW.toLocaleString('en-US')} / C.W:${grandTotalCW.toLocaleString('en-US')} KG</b>`;
                    }
                } else {
                    cargoTxt = '-';
                }
            } else if (['LCL', 'LTL', 'Bulk', 'All'].includes(state.load)) {
                const rows = document.querySelectorAll('#lcl-rows .cargo-row');
                const rowSummaries = [];
                let grandTotalGW = 0, grandTotalCBM = 0;
                let hasCompleteRow = false;
                
                rows.forEach((row, idx) => {
                    const l = row.querySelector('.lcl-l')?.value || '';
                    const w = row.querySelector('.lcl-w')?.value || '';
                    const h = row.querySelector('.lcl-h')?.value || '';
                    const qty = row.querySelector('.lcl-qty')?.value || '';
                    const gw = row.querySelector('.lcl-gross-weight')?.value || '';
                    const cbm = row.querySelector('.lcl-cbm')?.value || '0.0';
                    
                    const isComplete = l && l !== '0' && w && w !== '0' && h && h !== '0' && qty && qty !== '0' && gw && gw !== '0';
                    
                    if (isComplete) {
                        hasCompleteRow = true;
                        const qtyNum = parseInt(qty.replace(/,/g, ''), 10) || 0;
                        const gwNum = parseInt(gw.replace(/,/g, ''), 10) || 0;
                        const cbmNum = parseFloat(cbm) || 0;
                        
                        grandTotalGW += gwNum * qtyNum;
                        grandTotalCBM += cbmNum * qtyNum;
                        
                        rowSummaries.push(`#${idx + 1}: ${l}x${w}x${h}cm x ${qty}pcs`);
                    }
                });
                
                grandTotalCBM = Math.round(grandTotalCBM * 10) / 10;
                
                if (hasCompleteRow) {
                    if (rowSummaries.length === 1) {
                        const row = rows[0];
                        const l = row.querySelector('.lcl-l')?.value;
                        const w = row.querySelector('.lcl-w')?.value;
                        const h = row.querySelector('.lcl-h')?.value;
                        const qty = row.querySelector('.lcl-qty')?.value;
                        const gw = row.querySelector('.lcl-gross-weight')?.value;
                        const cbm = row.querySelector('.lcl-cbm')?.value;
                        cargoTxt = `${l}x${w}x${h}cm x ${qty}pcs<br>G.W:${gw}KG / CBM:${cbm}M³<br>Total G.W:${grandTotalGW.toLocaleString('en-US')}KG / CBM:${grandTotalCBM.toFixed(1)}M³`;
                    } else {
                        cargoTxt = rowSummaries.join('<br>') + `<br><span style="color:#888;">───</span><br><b>Total G.W:${grandTotalGW.toLocaleString('en-US')}KG / CBM:${grandTotalCBM.toFixed(1)}M³</b>`;
                    }
                } else {
                    cargoTxt = '-';
                }
            } else {
                cargoTxt = '-';
            }
            document.getElementById('s-cargo').innerHTML = cargoTxt;

            // Additional
            let adds = [];
            if(document.querySelector('input[name="export-cc"]:checked')?.value === 'yes') adds.push('Export CC');
            if(document.querySelector('input[name="import-cc"]:checked')?.value === 'yes') adds.push('Import CC');
            if(document.querySelector('input[name="pickup"]:checked')?.value === 'yes') adds.push('Pickup');
            if(document.querySelector('input[name="delivery"]:checked')?.value === 'yes') adds.push('Delivery');
            const inv = document.getElementById('invoice-val').value;
            if(inv) adds.push(`$${inv}`);
            
            document.getElementById('s-add').innerHTML = adds.length > 0 ? adds.join('<br>') : 'None';

            // Customer
            const co = document.getElementById('c-company').value;
            const name = document.getElementById('c-name').value;
            const email = document.getElementById('c-email').value;
            const phone = document.getElementById('c-phone').value;
            
            let custParts = [];
            if (co || name) custParts.push(`${co} / ${name}`);
            if (email) custParts.push(email);
            if (phone) custParts.push(phone);
            
            document.getElementById('s-cust').innerHTML = custParts.length > 0 ? custParts.join('<br>') : '-';
        }

        // ==========================================
        // FORM DATA COLLECTION
        // ==========================================
        function collectFormData() {
            const data = {
                // Trade & Shipping
                trade_mode: state.trade,
                shipping_type: state.ship,
                load_type: state.load,
                incoterms: state.incoterms,
                
                // Schedules
                pol: document.getElementById('input-pol').value.trim(),
                pod: document.getElementById('input-pod').value.trim(),
                etd: formatDateForAPI('etd'),
                eta: formatDateForAPI('eta'),
                
                // Cargo Details
                cargo: collectCargoData(),
                
                // DG (Dangerous Goods)
                is_dg: document.getElementById('dg-check').checked,
                dg_class: document.getElementById('dg-class')?.value.trim() || '',
                dg_un: document.getElementById('dg-un')?.value.trim() || '',
                
                // Reefer Temperature
                is_reefer: document.getElementById('reefer-temp-section')?.classList.contains('show') || false,
                temp_min: document.getElementById('temp-min')?.value.trim() || '',
                temp_max: document.getElementById('temp-max')?.value.trim() || '',
                temp_unit: tempUnit,
                
                // Additional Details
                export_cc: document.querySelector('input[name="export-cc"]:checked')?.value === 'yes',
                import_cc: document.querySelector('input[name="import-cc"]:checked')?.value === 'yes',
                shipping_insurance: document.querySelector('input[name="shipping-insurance"]:checked')?.value === 'yes',
                pickup_required: document.querySelector('input[name="pickup"]:checked')?.value === 'yes',
                pickup_address: document.getElementById('pickup-addr')?.value.trim() || '',
                delivery_required: document.querySelector('input[name="delivery"]:checked')?.value === 'yes',
                delivery_address: document.getElementById('delivery-addr')?.value.trim() || '',
                invoice_value: parseFloat(document.getElementById('invoice-val').value.replace(/,/g, '')) || 0,
                
                // Customer Information
                customer: {
                    company: document.getElementById('c-company').value.trim(),
                    job_title: document.getElementById('c-title').value.trim(),
                    name: document.getElementById('c-name').value.trim(),
                    email: document.getElementById('c-email').value.trim(),
                    phone: document.getElementById('c-phone').value.trim()
                },
                
                // Remark
                remark: document.getElementById('remark-textarea').value.trim()
            };
            
            return data;
        }
        
        function formatDateForAPI(prefix) {
            const year = document.getElementById(`${prefix}-year`).value;
            const month = document.getElementById(`${prefix}-month`).value;
            const day = document.getElementById(`${prefix}-day`).value;
            const hour = document.getElementById(`${prefix}-hour`)?.value || '';
            const minute = document.getElementById(`${prefix}-minute`)?.value || '';
            
            if (!year || !month || !day) return '';
            
            let dateStr = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            if (state.trade === 'domestic' && hour && minute) {
                dateStr += ` ${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
            }
            return dateStr;
        }
        
        function collectCargoData() {
            const cargoList = [];
            let container;
            
            if (state.load === 'FCL') {
                container = document.getElementById('fcl-rows');
                container?.querySelectorAll('.cargo-row').forEach(row => {
                    cargoList.push({
                        container_type: row.querySelector('.fcl-type')?.value || '',
                        gross_weight: parseFloat(row.querySelector('.fcl-weight')?.value.replace(/,/g, '') || 0),
                        cbm: parseFloat(row.querySelector('.fcl-cbm')?.value.replace(/,/g, '') || 0),
                        qty: parseInt(row.querySelector('.fcl-qty')?.value.replace(/,/g, '') || 0)
                    });
                });
            } else if (state.load === 'FTL') {
                container = document.getElementById('ftl-rows');
                container?.querySelectorAll('.cargo-row').forEach(row => {
                    cargoList.push({
                        truck_type: row.querySelector('.ftl-type')?.value || '',
                        qty: parseInt(row.querySelector('.ftl-qty')?.value.replace(/,/g, '') || 0)
                    });
                });
            } else if (state.load === 'Air') {
                container = document.getElementById('air-rows');
                container?.querySelectorAll('.cargo-row').forEach(row => {
                    cargoList.push({
                        length: parseInt(row.querySelector('.air-l')?.value.replace(/,/g, '') || 0),
                        width: parseInt(row.querySelector('.air-w')?.value.replace(/,/g, '') || 0),
                        height: parseInt(row.querySelector('.air-h')?.value.replace(/,/g, '') || 0),
                        qty: parseInt(row.querySelector('.air-qty')?.value.replace(/,/g, '') || 0),
                        gross_weight: parseInt(row.querySelector('.air-gross-weight')?.value.replace(/,/g, '') || 0),
                        volume_weight: parseInt(row.querySelector('.air-volume-weight')?.value.replace(/,/g, '') || 0),
                        chargeable_weight: parseInt(row.querySelector('.air-chargeable-weight')?.value.replace(/,/g, '') || 0)
                    });
                });
            } else {
                // LCL, LTL, Bulk, All
                container = document.getElementById('lcl-rows');
                container?.querySelectorAll('.cargo-row').forEach(row => {
                    cargoList.push({
                        length: parseInt(row.querySelector('.lcl-l')?.value.replace(/,/g, '') || 0),
                        width: parseInt(row.querySelector('.lcl-w')?.value.replace(/,/g, '') || 0),
                        height: parseInt(row.querySelector('.lcl-h')?.value.replace(/,/g, '') || 0),
                        qty: parseInt(row.querySelector('.lcl-qty')?.value.replace(/,/g, '') || 0),
                        gross_weight: parseInt(row.querySelector('.lcl-gross-weight')?.value.replace(/,/g, '') || 0),
                        cbm: parseFloat(row.querySelector('.lcl-cbm')?.value || 0)
                    });
                });
            }
            
            return cargoList;
        }

        // ==========================================
        // FORM VALIDATION
        // ==========================================
        function validateForm() {
            const errors = [];
            clearValidationErrors();
            
            // POL/POD validation
            const pol = document.getElementById('input-pol');
            const pod = document.getElementById('input-pod');
            if (!pol.value.trim()) {
                errors.push('POL (Port of Loading / Pickup Address) is required');
                pol.classList.add('error');
            }
            if (!pod.value.trim()) {
                errors.push('POD (Port of Discharging / Delivery Address) is required');
                pod.classList.add('error');
            }
            
            // ETD validation
            const etdYear = document.getElementById('etd-year');
            const etdMonth = document.getElementById('etd-month');
            const etdDay = document.getElementById('etd-day');
            const etdInputGroup = document.getElementById('etd-input-group');
            if (!etdYear.value || !etdMonth.value || !etdDay.value) {
                errors.push('Estimated Departure Date (ETD) is required');
                if (etdInputGroup) etdInputGroup.classList.add('error');
            } else if (state.trade !== 'domestic') {
                // Date validation for non-domestic
                const today = getTodayDate();
                const etdDate = getDateFromInputs('etd');
                if (etdDate) {
                    if (etdDate < today) {
                        errors.push('ETD cannot be in the past');
                        showDateError('etd', 'ETD cannot be in the past.');
                    } else if (etdDate.getTime() === today.getTime() && (state.ship === 'ocean' || state.ship === 'air')) {
                        errors.push('Please check ETD (cannot be today for Ocean/Air)');
                        showDateError('etd', 'Please check ETD.');
                    }
                }
            }
            
            // ETA validation
            const etaYear = document.getElementById('eta-year');
            const etaMonth = document.getElementById('eta-month');
            const etaDay = document.getElementById('eta-day');
            const etaInputGroup = document.getElementById('eta-input-group');
            if (!etaYear.value || !etaMonth.value || !etaDay.value) {
                errors.push('Estimated Arrival Date (ETA) is required');
                if (etaInputGroup) etaInputGroup.classList.add('error');
            } else if (state.trade !== 'domestic') {
                // Date validation for non-domestic
                const today = getTodayDate();
                const etdDate = getDateFromInputs('etd');
                const etaDate = getDateFromInputs('eta');
                if (etaDate) {
                    if (etaDate < today) {
                        errors.push('ETA cannot be in the past');
                        showDateError('eta', 'ETA cannot be in the past.');
                    } else if (etdDate && etaDate < etdDate) {
                        errors.push('ETA cannot be earlier than ETD');
                        showDateError('eta', 'ETA cannot be earlier than ETD.');
                    }
                }
            }
            
            // Invoice Value validation
            const invoiceVal = document.getElementById('invoice-val');
            if (!invoiceVal.value || parseFloat(invoiceVal.value.replace(/,/g, '')) <= 0) {
                errors.push('Invoice Value is required');
                invoiceVal.classList.add('error');
            }
            
            // FCL Gross Weight validation
            if (state.load === 'FCL') {
                const fclRows = document.querySelectorAll('#fcl-rows .cargo-row');
                fclRows.forEach((row, idx) => {
                    const weight = row.querySelector('.fcl-weight');
                    if (!weight.value || parseFloat(weight.value.replace(/,/g, '')) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Gross Weight is required for FCL`);
                        weight.classList.add('error');
                    }
                });
            }
            
            // LCL/Bulk cargo validation - all rows must have required fields
            if (['LCL', 'LTL', 'Bulk', 'All'].includes(state.load)) {
                const rows = document.querySelectorAll('#lcl-rows .cargo-row');
                rows.forEach((row, idx) => {
                    const lInput = row.querySelector('.lcl-l');
                    const wInput = row.querySelector('.lcl-w');
                    const hInput = row.querySelector('.lcl-h');
                    const qtyInput = row.querySelector('.lcl-qty');
                    const gwInput = row.querySelector('.lcl-gross-weight');
                    
                    const l = lInput?.value;
                    const w = wInput?.value;
                    const h = hInput?.value;
                    const qty = qtyInput?.value;
                    const gw = gwInput?.value;
                    
                    if (!l || parseFloat(l) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Length is required`);
                        if (lInput) lInput.classList.add('error');
                    }
                    if (!w || parseFloat(w) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Width is required`);
                        if (wInput) wInput.classList.add('error');
                    }
                    if (!h || parseFloat(h) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Height is required`);
                        if (hInput) hInput.classList.add('error');
                    }
                    if (!qty || parseInt(qty) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Pkg Qty is required`);
                        if (qtyInput) qtyInput.classList.add('error');
                    }
                    if (!gw || parseInt(gw.replace(/,/g, '')) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Gross Weight is required`);
                        if (gwInput) gwInput.classList.add('error');
                    }
                });
            }
            
            // Air cargo validation - all rows must have required fields
            if (state.load === 'Air') {
                const rows = document.querySelectorAll('#air-rows .cargo-row');
                rows.forEach((row, idx) => {
                    const lInput = row.querySelector('.air-l');
                    const wInput = row.querySelector('.air-w');
                    const hInput = row.querySelector('.air-h');
                    const qtyInput = row.querySelector('.air-qty');
                    const gwInput = row.querySelector('.air-gross-weight');
                    
                    const l = lInput?.value;
                    const w = wInput?.value;
                    const h = hInput?.value;
                    const qty = qtyInput?.value;
                    const gw = gwInput?.value;
                    
                    if (!l || parseFloat(l) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Length is required`);
                        if (lInput) lInput.classList.add('error');
                    }
                    if (!w || parseFloat(w) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Width is required`);
                        if (wInput) wInput.classList.add('error');
                    }
                    if (!h || parseFloat(h) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Height is required`);
                        if (hInput) hInput.classList.add('error');
                    }
                    if (!qty || parseInt(qty) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Pkg Qty is required`);
                        if (qtyInput) qtyInput.classList.add('error');
                    }
                    if (!gw || parseInt(gw.replace(/,/g, '')) <= 0) {
                        errors.push(`Cargo Row ${idx + 1}: Gross Weight is required`);
                        if (gwInput) gwInput.classList.add('error');
                    }
                });
            }
            
            // DG validation
            const dgCheck = document.getElementById('dg-check');
            if (dgCheck.checked) {
                const dgClass = document.getElementById('dg-class');
                const dgUn = document.getElementById('dg-un');
                if (!dgClass.value.trim()) {
                    errors.push('DG Class is required when Dangerous Goods is checked');
                    dgClass.classList.add('error');
                }
                if (!dgUn.value.trim()) {
                    errors.push('UN Number is required when Dangerous Goods is checked');
                    dgUn.classList.add('error');
                }
            }
            
            // Pickup Address validation
            const pickupRequired = document.querySelector('input[name="pickup"]:checked')?.value === 'yes';
            if (pickupRequired) {
                const pickupAddr = document.getElementById('pickup-addr');
                if (!pickupAddr.value.trim()) {
                    errors.push('Pickup Address is required when Pickup is selected');
                    pickupAddr.classList.add('error');
                }
            }
            
            // Delivery Address validation
            const deliveryRequired = document.querySelector('input[name="delivery"]:checked')?.value === 'yes';
            if (deliveryRequired) {
                const deliveryAddr = document.getElementById('delivery-addr');
                if (!deliveryAddr.value.trim()) {
                    errors.push('Delivery Address is required when Delivery is selected');
                    deliveryAddr.classList.add('error');
                }
            }
            
            // Customer Information validation
            const company = document.getElementById('c-company');
            const name = document.getElementById('c-name');
            const email = document.getElementById('c-email');
            const phone = document.getElementById('c-phone');
            
            if (!company.value.trim()) {
                errors.push('Company Name is required');
                company.classList.add('error');
            }
            if (!name.value.trim()) {
                errors.push('Name is required');
                name.classList.add('error');
            }
            if (!email.value.trim()) {
                errors.push('E-mail is required');
                email.classList.add('error');
            } else if (!isValidEmail(email.value.trim())) {
                errors.push('Please enter a valid email address');
                email.classList.add('error');
            }
            if (!phone.value.trim()) {
                errors.push('Phone is required');
                phone.classList.add('error');
            }
            
            // Remark validation (when highlighted/required)
            const remarkSection = document.getElementById('remark-section');
            const remarkTextarea = document.getElementById('remark-textarea');
            if (remarkSection.classList.contains('highlighted') && !remarkTextarea.value.trim()) {
                errors.push('Remark is required for this Incoterms selection');
                remarkTextarea.classList.add('error');
            }
            
            // Display errors
            if (errors.length > 0) {
                showValidationErrors(errors);
                return false;
            }
            
            return true;
        }
        
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function clearValidationErrors() {
            // Hide error container
            document.getElementById('validation-error').classList.remove('show');
            document.getElementById('validation-error-list').innerHTML = '';
            
            // Remove error class from all inputs
            document.querySelectorAll('.form-input.error').forEach(el => {
                el.classList.remove('error');
            });
            document.querySelectorAll('.date-input-group.error').forEach(el => {
                el.classList.remove('error');
            });
            
            // Hide date error messages
            hideDateError('etd');
            hideDateError('eta');
        }
        
        function showValidationErrors(errors) {
            const container = document.getElementById('validation-error');
            const list = document.getElementById('validation-error-list');
            
            list.innerHTML = errors.map(err => `<li>${err}</li>`).join('');
            container.classList.add('show');
            
            // Scroll to error container
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ==========================================
        // AI ASSISTANT INTEGRATION
        // ==========================================
        
        /**
         * AI에서 전달된 Quote 데이터로 폼 자동 채움
         */
        function checkAIQuoteData() {
            // URL 파라미터 확인
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('from') !== 'ai') return;
            
            // sessionStorage에서 데이터 가져오기
            const aiData = sessionStorage.getItem('ai_quote_data');
            if (!aiData) return;
            
            try {
                const data = JSON.parse(aiData);
                console.log('[AI Integration] Received quote data:', data);
                
                // 약간의 딜레이 후 폼 채움 (컨테이너 타입 로드 대기)
                setTimeout(() => {
                    applyAIQuoteData(data);
                    
                    // 성공 메시지 표시
                    showToast('AI 어시스턴트에서 데이터를 가져왔습니다.', 'success');
                    
                    // 데이터 삭제 (재사용 방지)
                    sessionStorage.removeItem('ai_quote_data');
                }, 500);
                
            } catch (error) {
                console.error('[AI Integration] Error parsing AI data:', error);
            }
        }
        
        /**
         * AI 데이터를 폼에 적용
         */
        function applyAIQuoteData(data) {
            // Trade Mode
            if (data.trade_mode) {
                setTrade(data.trade_mode);
            }
            
            // Shipping Type
            if (data.shipping_type) {
                setShip(data.shipping_type);
            }
            
            // Load Type
            if (data.load_type) {
                setTimeout(() => {
                    const loadCard = document.querySelector(`[onclick*="setLoad('${data.load_type}')"]`);
                    if (loadCard) loadCard.click();
                }, 100);
            }
            
            // POL (Port of Loading)
            if (data.pol) {
                const polInput = document.getElementById('input-pol');
                if (polInput) {
                    // 항구 코드를 직접 설정
                    polInput.value = data.pol;
                    state.pol = data.pol;
                    updateSummary();
                    
                    // 자동완성 트리거
                    polInput.dispatchEvent(new Event('input'));
                }
            }
            
            // POD (Port of Discharging)
            if (data.pod) {
                const podInput = document.getElementById('input-pod');
                if (podInput) {
                    podInput.value = data.pod;
                    state.pod = data.pod;
                    updateSummary();
                    podInput.dispatchEvent(new Event('input'));
                }
            }
            
            // Container Type
            if (data.container_type) {
                setTimeout(() => {
                    const containerSelect = document.querySelector('#fcl-rows .fcl-type');
                    if (containerSelect) {
                        // 옵션 중에서 매칭되는 것 찾기
                        const options = containerSelect.options;
                        for (let i = 0; i < options.length; i++) {
                            if (options[i].dataset.code === data.container_type || 
                                options[i].text.includes(data.container_type)) {
                                containerSelect.selectedIndex = i;
                                containerSelect.dispatchEvent(new Event('change'));
                                break;
                            }
                        }
                    }
                }, 300);
            }
            
            // ETD (Estimated Time of Departure)
            if (data.etd) {
                const etdParts = data.etd.split('-');
                if (etdParts.length === 3) {
                    const etdYear = document.getElementById('etd-year');
                    const etdMonth = document.getElementById('etd-month');
                    const etdDay = document.getElementById('etd-day');
                    
                    if (etdYear) etdYear.value = etdParts[0];
                    if (etdMonth) etdMonth.value = etdParts[1];
                    if (etdDay) etdDay.value = etdParts[2];
                    
                    // 날짜 유효성 검사 및 Quick Quotation 트리거
                    setTimeout(() => {
                        if (typeof triggerQuickQuotation === 'function') {
                            triggerQuickQuotation();
                        }
                    }, 500);
                }
            }
            
            // Summary 업데이트
            updateSummary();
        }
        
        // ==========================================
        // FORM SUBMISSION
        // ==========================================
        
        async function submitQuote() {
            // 로그인 상태 확인
            if (!window.Auth || !Auth.user) {
                // 로그인되지 않은 경우 로그인 모달 표시
                showToast('견적 요청을 위해 로그인이 필요합니다.', 'info');
                
                // 로그인 성공 후 콜백: Customer Information 자동 완성 및 재시도 안내
                Auth.openModalWithCallback(function(user) {
                    // Customer Information 자동 완성
                    populateCustomerInfoFromAuth();
                    
                    // 사용자에게 Submit 재시도 안내
                    showToast('로그인 완료! Submit 버튼을 다시 클릭해주세요.', 'success');
                }, 'shipper');
                
                return;
            }
            
            // 화주(shipper)만 견적 요청 가능
            if (Auth.user.user_type !== 'shipper') {
                showToast('화주(Shipper) 계정으로 로그인해야 견적을 요청할 수 있습니다.', 'error');
                return;
            }
            
            // Validate form
            if (!validateForm()) {
                return;
            }
            
            // Check for FCL weight exceeded (soft block)
            if (state.load === 'FCL') {
                const exceededRows = validateAllFclWeights();
                if (exceededRows.length > 0) {
                    const shouldContinue = await showWeightExceededModal(exceededRows);
                    if (!shouldContinue) {
                        return; // User cancelled
                    }
                }
            }
            
            // Collect form data
            const formData = collectFormData();
            
            // If editing an existing quote, include the bidding_no for update
            if (currentBiddingNo) {
                formData.bidding_no = currentBiddingNo;
            }
            
            // Show loading
            showLoading(true);
            
            // Log for debugging
            console.log('Form Data to Submit:', JSON.stringify(formData, null, 2));
            console.log('Mode:', currentBiddingNo ? 'UPDATE' : 'CREATE');
            
            // Determine API endpoint and method
            const apiUrl = currentBiddingNo 
                ? `${API_BASE_URL}/api/quote/update/${currentBiddingNo}`
                : `${API_BASE_URL}/api/quote/request`;
            const apiMethod = currentBiddingNo ? 'PUT' : 'POST';
            
            // API call
            fetch(apiUrl, {
                method: apiMethod,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        err.status = response.status;
                        return Promise.reject(err);
                    });
                }
                return response.json();
            })
            .then(data => {
                showLoading(false);
                if (data.success) {
                    // Show success with Bidding No and PDF download
                    showSuccessModal(data);
                    console.log('Success:', data);
                } else {
                    showToast(data.message || 'Failed to submit quote request', 'error');
                }
            })
            .catch(error => {
                showLoading(false);
                console.error('Submit error:', error);
                
                // If update failed with 404, reset bidding number and allow new submission
                if (currentBiddingNo && (error.detail?.includes('not found') || error.status === 404)) {
                    console.log('Bidding number not found, resetting for new submission');
                    currentBiddingNo = null;
                    showToast('Previous quote not found. Please submit as new quote.', 'error');
                } else {
                    const errorMsg = error.detail || error.message || 'Network error. Please try again.';
                    showToast(errorMsg, 'error');
                }
            });
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
        
        // ==========================================
        // SUCCESS MODAL & PDF DOWNLOAD
        // ==========================================
        
        let currentPdfUrl = null;
        let currentBiddingNo = null;
        
        function showSuccessModal(data) {
            const modal = document.getElementById('success-modal');
            
            // Set Bidding No and Deadline (from API response)
            document.getElementById('modal-bidding-no').textContent = data.bidding_no || '-';
            document.getElementById('modal-deadline').textContent = data.deadline ? `${data.deadline} (KST)` : '-';
            
            // Store Bidding No and PDF URL
            currentBiddingNo = data.bidding_no;
            currentPdfUrl = data.pdf_url;
            
            // Show/hide PDF button based on availability
            const pdfBtn = document.getElementById('btn-download-pdf');
            if (data.pdf_url) {
                pdfBtn.style.display = 'flex';
            } else {
                pdfBtn.style.display = 'none';
            }
            
            // Populate modal with form data
            populateModalWithFormData();
            
            // Show modal
            modal.classList.add('show');
        }
        
        function populateModalWithFormData() {
            // Customer Information
            document.getElementById('modal-customer').textContent = document.getElementById('c-company').value || '-';
            document.getElementById('modal-name').textContent = document.getElementById('c-name').value || '-';
            document.getElementById('modal-email').textContent = document.getElementById('c-email').value || '-';
            document.getElementById('modal-phone').textContent = document.getElementById('c-phone').value || '-';
            
            // Quotation Details
            document.getElementById('modal-trade-type').textContent = state.trade.charAt(0).toUpperCase() + state.trade.slice(1);
            document.getElementById('modal-shipping-mode').textContent = state.ship === 'ocean' ? 'Sea' : state.ship.charAt(0).toUpperCase() + state.ship.slice(1);
            document.getElementById('modal-incoterms').textContent = state.incoterms;
            document.getElementById('modal-load-type').textContent = state.load;
            document.getElementById('modal-dg').textContent = document.getElementById('dg-check').checked ? 'Y' : 'N';
            
            // Shipping Schedule
            const polValue = document.getElementById('input-pol').value;
            const podValue = document.getElementById('input-pod').value;
            document.getElementById('modal-pol').textContent = polValue ? polValue.split(' - ')[0] : '-';
            document.getElementById('modal-pod').textContent = podValue ? podValue.split(' - ')[0] : '-';
            
            // Format ETD
            const etdYear = document.getElementById('etd-year').value;
            const etdMonth = document.getElementById('etd-month').value;
            const etdDay = document.getElementById('etd-day').value;
            if (etdYear && etdMonth && etdDay) {
                document.getElementById('modal-etd').textContent = `${etdYear.slice(-2)}/${etdMonth.padStart(2, '0')}/${etdDay.padStart(2, '0')}`;
            } else {
                document.getElementById('modal-etd').textContent = '-';
            }
            
            // Format ETA
            const etaYear = document.getElementById('eta-year').value;
            const etaMonth = document.getElementById('eta-month').value;
            const etaDay = document.getElementById('eta-day').value;
            if (etaYear && etaMonth && etaDay) {
                document.getElementById('modal-eta').textContent = `${etaYear.slice(-2)}/${etaMonth.padStart(2, '0')}/${etaDay.padStart(2, '0')}`;
            } else {
                document.getElementById('modal-eta').textContent = '-';
            }
            
            // Additional Details - Dynamic based on visibility rules
            populateAdditionalDetails();
            
            // Cargo Details
            document.getElementById('modal-cargo-details').innerHTML = getCargoSummaryForModal();
        }
        
        function populateAdditionalDetails() {
            const container = document.getElementById('modal-additional-details');
            container.innerHTML = '';
            
            // Get visibility rules for current trade mode + incoterms
            const rules = VISIBILITY_RULES[state.trade]?.[state.incoterms];
            if (!rules) return;
            
            const showFields = rules.showFields || [];
            
            // Field definitions
            const fieldConfig = {
                'export-cc': {
                    name: 'Export Customs Clearance',
                    radioName: 'export-cc',
                    type: 'checkbox'
                },
                'import-cc': {
                    name: 'Import Customs Clearance',
                    radioName: 'import-cc',
                    type: 'checkbox'
                },
                'shipping-insurance': {
                    name: 'Shipping Insurance',
                    radioName: 'ship-insurance',
                    type: 'checkbox'
                },
                'pickup': {
                    name: 'Pickup',
                    radioName: 'pickup',
                    type: 'checkbox-address',
                    addressId: 'pickup-addr'
                },
                'delivery': {
                    name: 'Delivery',
                    radioName: 'delivery',
                    type: 'checkbox-address',
                    addressId: 'delivery-addr'
                }
            };
            
            // Build rows for visible fields
            showFields.forEach(fieldKey => {
                if (fieldKey === 'invoice') return; // Invoice handled separately
                
                const config = fieldConfig[fieldKey];
                if (!config) return;
                
                const isChecked = document.querySelector(`input[name="${config.radioName}"]:checked`)?.value === 'yes';
                const row = document.createElement('div');
                row.className = 'rfq-service-row';
                
                if (config.type === 'checkbox') {
                    row.innerHTML = `
                        <span class="rfq-service-name">${config.name}</span>
                        <span class="rfq-service-check ${isChecked ? 'checked' : 'unchecked'}">
                            <i class="fas ${isChecked ? 'fa-check-square' : 'fa-times'}"></i>
                        </span>
                    `;
                } else if (config.type === 'checkbox-address') {
                    const address = document.getElementById(config.addressId)?.value || '';
                    // Only show address if checked and has value
                    const addressHtml = isChecked && address 
                        ? `<span class="rfq-service-address">${address}</span>` 
                        : '';
                    row.innerHTML = `
                        <span class="rfq-service-name">${config.name}</span>
                        <span class="rfq-service-check ${isChecked ? 'checked' : 'unchecked'}">
                            <i class="fas ${isChecked ? 'fa-check-square' : 'fa-times'}"></i>
                        </span>
                        ${addressHtml}
                    `;
                }
                
                container.appendChild(row);
            });
            
            // Always add Invoice Value at the end if 'invoice' is in showFields
            if (showFields.includes('invoice')) {
                const invoiceValue = document.getElementById('invoice-val')?.value || '0';
                const invoiceRow = document.createElement('div');
                invoiceRow.className = 'rfq-service-row';
                invoiceRow.innerHTML = `
                    <span class="rfq-service-name">Invoice Value (USD)</span>
                    <span class="rfq-service-value">$ ${invoiceValue}</span>
                `;
                container.appendChild(invoiceRow);
            }
        }
        
        function getCargoSummaryForModal() {
            let summary = '';
            
            if (state.load === 'FCL') {
                const rows = document.querySelectorAll('#fcl-rows .cargo-row');
                const items = [];
                rows.forEach(row => {
                    const select = row.querySelector('.fcl-type');
                    const type = select?.value || '';
                    const qty = row.querySelector('.fcl-qty')?.value.replace(/,/g, '') || '0';
                    if (type && parseInt(qty) > 0) {
                        // Get container code from selected option's data attribute or lookup from state
                        const selectedOption = select?.options[select.selectedIndex];
                        let shortType = selectedOption?.dataset?.code || 
                            state.containerTypes.find(ct => ct.name === type)?.code || type;
                        items.push(`${shortType} X ${qty}`);
                    }
                });
                summary = items.length > 0 ? items.join(', ') : '-';
                
                // Add Reefer Temperature if active
                const reeferSection = document.getElementById('reefer-temp-section');
                if (reeferSection && reeferSection.classList.contains('show')) {
                    const tempMin = document.getElementById('temp-min')?.value.trim() || '';
                    const tempMax = document.getElementById('temp-max')?.value.trim() || '';
                    if (tempMin || tempMax) {
                        const unitSymbol = tempUnit === 'C' ? '°C' : '°F';
                        const tempRange = tempMin && tempMax 
                            ? `${tempMin} ~ ${tempMax}${unitSymbol}`
                            : tempMin 
                                ? `${tempMin}${unitSymbol}`
                                : `${tempMax}${unitSymbol}`;
                        summary += `<br><span style="color: #00bcd4;"><i class="fas fa-thermometer-half"></i> Temp: ${tempRange}</span>`;
                    }
                }
            } else if (state.load === 'FTL') {
                const rows = document.querySelectorAll('#ftl-rows .cargo-row');
                const items = [];
                rows.forEach(row => {
                    const type = row.querySelector('.ftl-type')?.value || '';
                    const qty = row.querySelector('.ftl-qty')?.value.replace(/,/g, '') || '0';
                    if (type && parseInt(qty) > 0) {
                        items.push(`${type} X ${qty}`);
                    }
                });
                summary = items.length > 0 ? items.join(', ') : '-';
            } else if (state.load === 'Air') {
                const rows = document.querySelectorAll('#air-rows .cargo-row');
                let totalGW = 0, totalCW = 0, totalPcs = 0;
                rows.forEach(row => {
                    const qty = parseInt(row.querySelector('.air-qty')?.value.replace(/,/g, '') || 0);
                    const gw = parseInt(row.querySelector('.air-gross-weight')?.value.replace(/,/g, '') || 0);
                    const cw = parseInt(row.querySelector('.air-chargeable-weight')?.value.replace(/,/g, '') || 0);
                    totalPcs += qty;
                    totalGW += gw * qty;
                    totalCW += cw * qty;
                });
                if (totalPcs > 0) {
                    summary = `${totalPcs} PCS / G.W: ${totalGW.toLocaleString()} KG / C.W: ${totalCW.toLocaleString()} KG`;
                } else {
                    summary = '-';
                }
            } else {
                // LCL, LTL, Bulk, All
                const rows = document.querySelectorAll('#lcl-rows .cargo-row');
                let totalGW = 0, totalCBM = 0, totalPcs = 0;
                rows.forEach(row => {
                    const qty = parseInt(row.querySelector('.lcl-qty')?.value.replace(/,/g, '') || 0);
                    const gw = parseInt(row.querySelector('.lcl-gross-weight')?.value.replace(/,/g, '') || 0);
                    const cbm = parseFloat(row.querySelector('.lcl-cbm')?.value || 0);
                    totalPcs += qty;
                    totalGW += gw * qty;
                    totalCBM += cbm * qty;
                });
                totalCBM = Math.round(totalCBM * 10) / 10;
                if (totalPcs > 0) {
                    summary = `${totalPcs} PCS / G.W: ${totalGW.toLocaleString()} KG / CBM: ${totalCBM.toFixed(1)} M³`;
                } else {
                    summary = '-';
                }
            }
            
            return summary;
        }
        
        function closeSuccessModal() {
            const modal = document.getElementById('success-modal');
            modal.classList.remove('show');
            currentPdfUrl = null;
            // Note: currentBiddingNo is NOT reset here to allow updating the same quote on re-submit
        }
        
        function downloadPDF() {
            if (currentPdfUrl) {
                // Open PDF in new tab or trigger download
                window.open(`${API_BASE_URL}${currentPdfUrl}`, '_blank');
            } else {
                showToast('PDF not available', 'error');
            }
        }
        
        // Close modal on outside click
        document.getElementById('success-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSuccessModal();
            }
        });
    </script>

    <!-- Auth Modal -->
    <div class="auth-modal-overlay" id="authModalOverlay">
        <div class="auth-modal">
            <div class="auth-modal-header">
                <h3 class="auth-modal-title" id="authModalTitle">로그인</h3>
                <button class="auth-modal-close" onclick="Auth.closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="auth-modal-body">
                <!-- Step Indicator -->
                <div class="auth-steps">
                    <div class="auth-step active"></div>
                    <div class="auth-step"></div>
                </div>
                
                <!-- Login Type Selection View -->
                <div id="loginTypeView">
                    <p style="text-align: center; color: var(--text-sub); margin-bottom: 1.5rem;">
                        로그인 유형을 선택해주세요
                    </p>
                    <div class="user-type-selector">
                        <button class="user-type-option" onclick="Auth.selectLoginType('shipper')">
                            <i class="fas fa-building"></i>
                            <span class="type-label">화주 (Shipper)</span>
                            <span class="type-desc">화물 운송을 의뢰하는 기업</span>
                        </button>
                        <button class="user-type-option" onclick="Auth.selectLoginType('forwarder')">
                            <i class="fas fa-truck"></i>
                            <span class="type-label">포워더 (Forwarder)</span>
                            <span class="type-desc">운송 서비스를 제공하는 기업</span>
                        </button>
                    </div>
                    <div class="auth-divider">
                        <span>또는</span>
                    </div>
                    <p class="auth-form-hint" style="text-align: center;">
                        아직 계정이 없으신가요? 
                        <a onclick="Auth.showRegisterTypeView()">회원가입</a>
                    </p>
                </div>
                
                <!-- Login Form View -->
                <div id="loginView" style="display: none;">
                    <button class="auth-back-btn" onclick="Auth.goBackToLoginType()">
                        <i class="fas fa-arrow-left"></i> 로그인 유형 선택
                    </button>
                    <div class="auth-error" id="loginError"></div>
                    <div class="auth-form">
                        <div class="auth-form-group">
                            <label class="auth-form-label required">이메일</label>
                            <input type="email" class="auth-form-input" id="loginEmail" 
                                   placeholder="example@company.com" autocomplete="email">
                        </div>
                        <div class="auth-form-group">
                            <label class="auth-form-label required">비밀번호</label>
                            <div class="password-field">
                                <input type="password" class="auth-form-input" id="loginPassword" 
                                       placeholder="비밀번호를 입력하세요" autocomplete="current-password">
                                <button type="button" class="password-toggle">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button class="auth-submit-btn" id="loginSubmitBtn" onclick="Auth.submitLogin()">
                            로그인
                        </button>
                    </div>
                </div>
                
                <!-- Register Type Selection View -->
                <div id="registerTypeView" style="display: none;">
                    <button class="auth-back-btn" onclick="Auth.goBack()">
                        <i class="fas fa-arrow-left"></i> 뒤로
                    </button>
                    <p style="text-align: center; color: var(--text-sub); margin-bottom: 1.5rem;">
                        회원 유형을 선택해주세요
                    </p>
                    <div class="user-type-selector">
                        <button class="user-type-option" onclick="Auth.selectUserType('shipper')">
                            <i class="fas fa-building"></i>
                            <span class="type-label">화주 (Shipper)</span>
                            <span class="type-desc">화물 운송을 의뢰하는 기업</span>
                        </button>
                        <button class="user-type-option" onclick="Auth.selectUserType('forwarder')">
                            <i class="fas fa-truck"></i>
                            <span class="type-label">포워더 (Forwarder)</span>
                            <span class="type-desc">운송 서비스를 제공하는 기업</span>
                        </button>
                    </div>
                    <p class="auth-form-hint" style="text-align: center; margin-top: 1.5rem;">
                        이미 계정이 있으신가요? 
                        <a onclick="Auth.showLoginTypeView()">로그인</a>
                    </p>
                </div>
                
                <!-- Register Form View -->
                <div id="registerFormView" style="display: none;">
                    <button class="auth-back-btn" onclick="Auth.goBack()">
                        <i class="fas fa-arrow-left"></i> 회원 유형 선택
                    </button>
                    <div class="auth-error"></div>
                    <div class="auth-success"></div>
                    <div class="auth-form">
                        <div class="auth-form-row">
                            <div class="auth-form-group">
                                <label class="auth-form-label required">회사명</label>
                                <input type="text" class="auth-form-input" id="regCompany" 
                                       placeholder="회사명을 입력하세요">
                            </div>
                            <div class="auth-form-group">
                                <label class="auth-form-label">사업자등록번호</label>
                                <input type="text" class="auth-form-input" id="regBusinessNo" 
                                       placeholder="000-00-00000">
                            </div>
                        </div>
                        <div class="auth-form-row">
                            <div class="auth-form-group">
                                <label class="auth-form-label required">담당자명</label>
                                <input type="text" class="auth-form-input" id="regName" 
                                       placeholder="담당자명">
                            </div>
                            <div class="auth-form-group">
                                <label class="auth-form-label required">연락처</label>
                                <input type="tel" class="auth-form-input" id="regPhone" 
                                       placeholder="010-0000-0000">
                            </div>
                        </div>
                        <div class="auth-form-group">
                            <label class="auth-form-label required">이메일</label>
                            <input type="email" class="auth-form-input" id="regEmail" 
                                   placeholder="example@company.com" autocomplete="email">
                        </div>
                        <div class="auth-form-row">
                            <div class="auth-form-group">
                                <label class="auth-form-label required">비밀번호</label>
                                <div class="password-field">
                                    <input type="password" class="auth-form-input" id="regPassword" 
                                           placeholder="8자 이상, 영문+숫자" autocomplete="new-password">
                                    <button type="button" class="password-toggle">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="auth-form-group">
                                <label class="auth-form-label required">비밀번호 확인</label>
                                <div class="password-field">
                                    <input type="password" class="auth-form-input" id="regPasswordConfirm" 
                                           placeholder="비밀번호 재입력" autocomplete="new-password">
                                    <button type="button" class="password-toggle">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button class="auth-submit-btn" id="registerSubmitBtn" onclick="Auth.submitRegister()">
                            <i class="fas fa-user-plus"></i> 회원가입
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth JavaScript -->
    <script src="../js/features/auth.js"></script>

</body>
</html>